<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  {% load static %}
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}ŸÑŸàÿ≠ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
  <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/fontawesome.min.css" />
  <link rel="stylesheet" href="/assets/animate.min.css" />
  <link rel="icon" href="{% static 'img/favicon.ico' %}" />
  <style>
    @font-face {
      font-family: 'Noto Kufi Arabic';
      font-style: normal;
      font-weight: 100 900;
      src: url("{% static 'fonts/ArbFonts.com/ArbFONTS-NotoKufiArabic-VariableFont_wght.ttf' %}") format('truetype');
      font-display: swap;
    }
    @font-face {
      font-family: 'Amiri';
      font-style: normal;
      font-weight: 400;
      src: url("{% static 'fonts/Amiri/Amiri-Regular.ttf' %}") format('truetype');
      font-display: swap;
    }
    :root {
      --maron-primary: #6f0d0d; /* Maroon */
      --maron-primary-700: #6b1717;
      --maron-primary-900: #6f0d0d;
      --maron-accent: #c49a6c; /* warm gold accent */
      --maron-bg: #faf8f7;
    }
    html, body { height: 100%; }
    body {
      font-family: 'Noto Kufi Arabic', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--maron-bg);
      color: #222;
      display: flex; flex-direction: column;
    }
    .navbar-maronia {
      background: linear-gradient(90deg, var(--maron-primary), var(--maron-primary-700));
    }
    .navbar-maronia .navbar-brand, .navbar-maronia .nav-link, .navbar-maronia .navbar-text {
      color: #fff !important;
    }
    .brand-images img { height: 34px; }
    .brand-images { gap: 0; }
    .brand-divider { display: none !important; width: 0; height: 0; margin: 0; }
    /* Metallic gold brand (static, no animation) */
    .brand-logo-gold,
    .brand-name-gold {
      display: inline-block;
      background-image: conic-gradient(
        from 0deg,
        #8B7500 0%, #B8860B 12%, #D4AF37 28%, #FFD700 44%, #E6C200 60%, #B8860B 78%, #8B7500 90%, #D4AF37 100%
      ), linear-gradient(45deg, rgba(255,255,255,.12), rgba(255,255,255,.02));
      background-blend-mode: overlay, normal;
      background-size: 120% 120%, 200% 200%;
      background-position: center, 200% 0;
      -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat;
      -webkit-mask-position: center; mask-position: center;
      -webkit-mask-size: contain; mask-size: contain;
      animation: none !important;
    }
    .brand-logo-gold {
      width: 44px; height: 44px;
      -webkit-mask-image: url("{% static 'img/logo.png' %}?v=20251027-02");
      mask-image: url("{% static 'img/logo.png' %}?v=20251027-02");
    }
    .brand-name-gold {
      height: calc(32px * 1.2); width: calc(360px * 1.2);
      -webkit-mask-image: url("{% static 'img/school_name.png' %}?v=20251027-02");
      mask-image: url("{% static 'img/school_name.png' %}?v=20251027-02");
    }
    .btn-maron {
      background-color: var(--maron-primary); color: #fff; border-color: var(--maron-primary);
    }
    .btn-maron:hover { background-color: var(--maron-primary-700); border-color: var(--maron-primary-700); }
    .text-accent { color: var(--maron-accent) !important; }
    .badge-accent { background-color: var(--maron-accent); }

    main { flex: 1 0 auto; }
    footer { flex-shrink: 0; background: #fff; border-top: 1px solid rgba(0,0,0,.06); }

    /* Tables */
    .table-card { box-shadow: 0 6px 24px rgba(0,0,0,.06); background: #fff; border-radius: .75rem; overflow: hidden; }
    .table thead th { position: sticky; top: 0; z-index: 2; background: #f7f2f1; }
    .table-hover tbody tr:hover { background-color: rgba(203, 153, 126, 0.08); }
    .table thead a { color: inherit; text-decoration: none; }
    .table thead a:hover { text-decoration: underline; }
  </style>
  <script>
window.getSchoolDayOfWeek = function() {
  const d = new Date();
  const iso = d.getDay(); // Sunday=0
  return (iso === 0) ? 1 : iso + 1; // Sunday=1, Monday=2, ..., Saturday=7
};
// Diagnostic
console.log('getSchoolDayOfWeek:', window.getSchoolDayOfWeek());
</script>
  <style>
    .page-header {
      border-inline-start: 4px solid var(--maron-accent);
      padding-inline-start: .75rem;
    }

    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 28px rgba(0,0,0,.08); }
  </style>
  <script src="https://cdn.lordicon.com/lordicon.js"></script>
  <style>
    /* Decorative hero above tables */
    .table-hero { display:flex; align-items:center; gap:.75rem; margin:.25rem 0 .5rem; }
    .table-hero .title { font-weight:700; }
    .table-hero .muted { color:#666; font-size:.9rem; }
    .table-hero lord-icon { width:40px; height:40px; }
  </style>
  <style>
    /* Spacing helpers */
    .section-auto { margin-block: 1rem; }
    .gap-6 { gap: 2.5rem !important; }
    .px-section { padding-inline: min(3vw, 24px) !important; }

    /* Card / panel helpers */
    .auto-card, .card { box-shadow: 0 6px 24px rgba(0,0,0,.06); border-radius: .75rem; background: #fff; }
    .auto-card:hover { transform: translateY(-2px); box-shadow: 0 10px 28px rgba(0,0,0,.08); }
    .soft-shadow { box-shadow: 0 4px 16px rgba(0,0,0,.05) !important; }
    .elevate:hover { transform: translateY(-2px); box-shadow: 0 10px 28px rgba(0,0,0,.1); }

    /* Text helpers */
    .lead-muted { color:#6c757d; font-size: .95rem; }
    .text-balance { text-wrap: balance; }
    .truncate { max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .word-break { word-break: break-word; }

    /* Scroll helpers */
    .table-wrap, .scroll-x { overflow-x:auto; }
    .scroll-y { overflow-y:auto; }

    /* Selection helpers */
    .no-select { user-select: none; -webkit-user-select: none; }

    /* Page header subtle gradient and radius */
    .page-header { background: linear-gradient(90deg, rgba(196,154,108,.08), rgba(123,30,30,.04)); border-radius: .5rem; }

    /* Print: avoid cutting tables and hide decorative elements */
    @media print {
      .no-print, [data-aos], .navbar, footer { display: none !important; }
      .table-wrap, .scroll-x, .scroll-y { overflow: visible !important; }
      .card, .auto-card { box-shadow: none !important; border: 1px solid #ddd; }
    }

    /* Reduced motion respect */
    @media (prefers-reduced-motion: reduce) {
      .auto-card:hover, .elevate:hover { transform: none; }
    }
  </style>
  <style>
    /* Ensure elements are visible before AOS initializes */
    html:not(.aos-ready) [data-aos] { opacity: 1 !important; transform: none !important; }
  </style>
  <style>
    /* Lordicon fallback: show Bootstrap icon if Lordicon is unavailable */
    html:not(.lordicon-ready) .li-fallback { display: inline !important; }
    html:not(.lordicon-ready) lord-icon { display: none !important; }
  </style>
  <style>
    /* Global site background image overlay (50% opacity) */
    body.site-bg::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image: url('{% static "img/portal_bg.png" %}');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.5; /* 50% */
      pointer-events: none;
      z-index: -1;
    }
  </style>
  {% block extra_head %}{% endblock %}
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-maronia shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold d-flex align-items-center" href="/">
        <span class="brand-images d-flex align-items-center">
          <img src="{% static 'img/logo02.png' %}?v=20251027-01" alt="ÿ¥ÿπÿßÿ±" style="height:44px; width:auto; display:block;"/>
        </span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain" aria-controls="navMain" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navMain">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul>
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          {% if request.user.is_authenticated %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-user-circle me-1 text-accent animate__animated animate__fadeIn"></i> {{ request.user.username }}
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="/">ŸÑŸàÿ≠ÿ™Ÿä</a></li>
                <li><a class="dropdown-item" href="/admin/" target="_blank">ŸÑŸàÿ≠ÿ© ÿßŸÑÿ•ÿØÿßÿ±ÿ©</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{% url 'logout' %}">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</a></li>
              </ul>
            </li>
          {% else %}
            <li class="nav-item"><a class="nav-link" href="{% url 'login' %}"><i class="fas fa-sign-in-alt me-1 text-accent animate__animated animate__fadeIn"></i> ÿØÿÆŸàŸÑ</a></li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>

  <main class="container-fluid py-4">
    {% if messages %}
      <div class="mb-3">
        {% for message in messages %}
          {% if message.tags == 'success' %}
            <div class="alert alert-success border-0" role="alert"><i class="bi bi-check-circle-fill me-1"></i> {{ message }}</div>
          {% elif message.tags == 'error' or message.tags == 'danger' %}
            <div class="alert alert-danger border-0" role="alert"><i class="bi bi-exclamation-octagon-fill me-1"></i> {{ message }}</div>
          {% elif message.tags == 'warning' %}
            <div class="alert alert-warning border-0" role="alert"><i class="bi bi-exclamation-triangle-fill me-1"></i> {{ message }}</div>
          {% else %}
            <div class="alert alert-info border-0" role="alert"><i class="bi bi-info-circle-fill me-1"></i> {{ message }}</div>
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}
    {% block content %}{% endblock %}
  </main>

  <footer class="py-3">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <div class="small text-muted">¬© 2025 ‚Äî ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ© - ŸÖÿØÿ±ÿ≥ÿ© ÿßŸÑÿ¥ÿ≠ÿßŸÜŸäÿ© ÿßŸÑÿßÿπÿØÿßÿØŸäÿ© ÿßŸÑÿ´ÿßŸÜŸàŸäÿ©</div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
  <script>
    // Ÿàÿ¨ŸàÿØ ÿØÿßŸÑÿ© ÿπÿßŸÖÿ© ŸÑÿ•Ÿäÿ¨ÿßÿØ ŸäŸàŸÖ ÿßŸÑŸÖÿØÿ±ÿ≥ÿ© ŸàŸÅŸÇ ÿßŸÑÿ™ÿ±ŸÇŸäŸÖ ÿßŸÑÿ¨ÿØŸäÿØ (ÿßŸÑÿ£ÿ≠ÿØ=1..ÿßŸÑÿ≥ÿ®ÿ™=7)
    window.getSchoolDayOfWeek = function() {
      const d = new Date();
      const jsDay = d.getDay(); // Sun=0 ... Sat=6
      return (jsDay === 0) ? 1 : (jsDay + 1);
    };
    // Diagnostic
    console.log('getSchoolDayOfWeek:', window.getSchoolDayOfWeek());
    (function(){
      // Mark lordicon readiness for fallbacks
      if (window.lordicon) { document.documentElement.classList.add('lordicon-ready'); }
      // Mark AOS readiness to control pre-init visibility
      document.documentElement.classList.add('aos-ready');

      // Enable Bootstrap tooltips globally (idempotent)
      const tooltipTriggerList = Array.prototype.slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.forEach(function (el) { try { new bootstrap.Tooltip(el); } catch(_){} });

      // Global background activation: use site-bg unless a page sets 'portal-bg'
      document.addEventListener('DOMContentLoaded', function(){
        if (!document.body.classList.contains('portal-bg')) {
          document.body.classList.add('site-bg');
        }
      });

      // Initialize AOS animations lazily
      if (window.AOS) {
        const reduceMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        AOS.init({
          duration: reduceMotion ? 0 : 600,
          easing: 'ease-out',
          once: false,
          mirror: true,
          startEvent: 'DOMContentLoaded',
          disable: reduceMotion
        });
        try { window.addEventListener('load', function(){ AOS.refreshHard(); }); } catch(_){}
        try { document.addEventListener('htmx:afterSwap', function(){ AOS.refreshHard(); }); } catch(_){}
      }

      // Auto-enhancer: decorate common blocks across pages without modifying each template
      function autoEnhance(){
        try {
          // Page headers: add AOS if missing
          document.querySelectorAll('.page-header').forEach(function(h){
            if (!h.getAttribute('data-aos')) { h.setAttribute('data-aos', 'fade-down'); }
          });
          // Cards: subtle fade-up (avoid applying to generic .row to prevent layout glitches)
          document.querySelectorAll('.card').forEach(function(el){
            if (!el.getAttribute('data-aos')) { el.setAttribute('data-aos', 'fade-up'); }
          });
          // Tables: ensure wrapped and sticky headers
          document.querySelectorAll('table.table').forEach(function(tbl){
            try {
              // sticky head is handled by CSS in base; ensure container scroll when needed
              if (!tbl.closest('.table-wrap')){
                const wrap = document.createElement('div');
                wrap.className = 'table-wrap';
                const parent = tbl.parentNode; parent.insertBefore(wrap, tbl); wrap.appendChild(tbl);
              }
            } catch(_){}
          });

          // Inject default animated icon into page headers if missing (site identity everywhere)
          document.querySelectorAll('.page-header .h1, .page-header h1, .page-header .h2, .page-header h2').forEach(function(h){
            try {
              if (!h.querySelector('lord-icon')){
                const li = document.createElement('lord-icon');
                li.setAttribute('src','https://cdn.lordicon.com/kndkiwmf.json');
                li.setAttribute('trigger','hover');
                li.setAttribute('colors','primary:#c49a6c,secondary:#7b1e1e');
                li.style.width='28px'; li.style.height='28px';
                const fallback = document.createElement('i');
                fallback.className = 'bi bi-stars text-accent me-1 li-fallback';
                h.classList.add('d-flex','align-items-center','gap-2');
                h.prepend(fallback);
                h.prepend(li);
              }
            } catch(_){}
          });

          // Arabic aria and labels if missing
          document.querySelectorAll('nav[aria-label]:not([aria-label*="ÿßŸÑÿπÿ±ÿ∂"])').forEach(function(n){
            // leave existing aria labels; this is conservative
          });
        } catch(_){}
      }

      // Global micro-utilities
      function initUtilities(){
        try {
          // 1) Copy-to-clipboard: elements with [data-copy] or .js-copy[data-target]
          document.addEventListener('click', function(e){
            const t1 = e.target.closest('[data-copy]');
            const t2 = e.target.closest('.js-copy');
            let text = null;
            if (t1) {
              text = t1.getAttribute('data-copy') || '';
            } else if (t2) {
              const sel = t2.getAttribute('data-target');
              const el = sel ? document.querySelector(sel) : null;
              if (el) { text = (el.innerText || el.textContent || '').trim(); }
            }
            if (text) {
              try {
                navigator.clipboard.writeText(text).then(()=>{
                  const prev = (t1||t2).textContent;
                  (t1||t2).textContent = 'ŸÜŸèÿ≥ÿÆ';
                  setTimeout(()=>{ (t1||t2).textContent = prev; }, 1200);
                });
              } catch(_){ /* ignore */ }
            }
          });

          // 2) External links hardening
          const origin = location.origin;
          document.querySelectorAll('a[href^="http"]:not([data-internal])').forEach(function(a){
            try {
              if (!a.href.startsWith(origin)) {
                if (!a.target) a.target = '_blank';
                const rel = (a.getAttribute('rel')||'').split(' ').filter(Boolean);
                if (!rel.includes('noopener')) rel.push('noopener');
                if (!rel.includes('noreferrer')) rel.push('noreferrer');
                a.setAttribute('rel', rel.join(' '));
              }
            } catch(_){ }
          });

          // 3) HTMX tiny top progress bar
          if (window.htmx && !document.getElementById('htmx-progress')){
            const bar = document.createElement('div');
            bar.id = 'htmx-progress';
            bar.style.cssText = 'position:fixed;inset-inline-start:0;top:0;height:3px;width:0;background:linear-gradient(90deg,#c49a6c,#7b1e1e);z-index:2147483647;transition:width .3s ease,opacity .4s ease;opacity:0;';
            document.body.appendChild(bar);
            const start = ()=>{ bar.style.opacity='1'; bar.style.width='15%'; setTimeout(()=>{ bar.style.width='55%'; }, 150); };
            const end = ()=>{ bar.style.width='100%'; setTimeout(()=>{ bar.style.opacity='0'; bar.style.width='0'; }, 350); };
            document.body.addEventListener('htmx:beforeRequest', start);
            document.body.addEventListener('htmx:afterOnLoad', end);
            document.body.addEventListener('htmx:responseError', end);
          }
        } catch(_){ }
      }

      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        autoEnhance();
        initUtilities();
      } else {
        document.addEventListener('DOMContentLoaded', function(){ autoEnhance(); initUtilities(); });
      }
    })();

    // Global helper: Convert JS Date.getDay() to school format (Sun=1, Sat=7)
    window.getSchoolDayOfWeek = function() {
      const jsDay = new Date().getDay(); // Sun=0, Mon=1, Tue=2, Wed=3, Thu=4, Fri=5, Sat=6
      return jsDay === 0 ? 1 : (jsDay + 1); // Sun=1, Mon=2, Tue=3, Wed=4, Thu=5, Fri=6, Sat=7
    };

    // Auto-fix: Highlight current day/period in all timetable pages
    (function(){
      try {
        document.addEventListener('DOMContentLoaded', function(){
          const schoolDow = window.getSchoolDayOfWeek();
          const now = new Date();
          const currentHour = now.getHours();
          const currentMin = now.getMinutes();
          const currentTotalMin = currentHour * 60 + currentMin;

          // Period schedule (can be overridden per page)
          const periods = [
            {num: 1, start: 7*60+15, end: 7*60+55},
            {num: 2, start: 8*60, end: 8*60+40},
            {num: 3, start: 8*60+45, end: 9*60+25},
            {num: 4, start: 9*60+50, end: 10*60+30},
            {num: 5, start: 10*60+35, end: 11*60+15},
            {num: 6, start: 11*60+20, end: 12*60},
            {num: 7, start: 12*60+5, end: 12*60+45}
          ];

          let currentPeriod = null;
          for(const p of periods){
            if(currentTotalMin >= p.start && currentTotalMin <= p.end){
              currentPeriod = p.num;
              break;
            }
          }

          console.log('üïê Current Time:', now.toLocaleTimeString('ar-SA'));
          console.log('üìÖ School Day:', schoolDow, ['ÿßŸÑÿ£ÿ≠ÿØ','ÿßŸÑÿ•ÿ´ŸÜŸäŸÜ','ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°','ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°','ÿßŸÑÿÆŸÖŸäÿ≥','ÿßŸÑÿ¨ŸÖÿπÿ©','ÿßŸÑÿ≥ÿ®ÿ™'][schoolDow-1]);
          console.log('üìö Current Period:', currentPeriod || 'Not in class time');

          // Find and highlight current period elements
          // Support various selector patterns
          const selectors = [
            `[data-day="${schoolDow}"][data-period="${currentPeriod}"]`,
            `.day-${schoolDow}.period-${currentPeriod}`,
            `.tw-slot[data-day="${schoolDow}"][data-period="${currentPeriod}"]`
          ];

          selectors.forEach(sel => {
            document.querySelectorAll(sel).forEach(el => {
              el.classList.add('current-period-highlight');
              el.style.border = '2px solid #22c55e';
              el.style.boxShadow = '0 0 12px rgba(34, 197, 94, 0.4)';
              el.style.background = '#f0fdf4';
            });
          });

          // Find day columns and highlight current day
          document.querySelectorAll('[data-day]').forEach(el => {
            const dayNum = parseInt(el.getAttribute('data-day'));
            if(dayNum === schoolDow){
              el.classList.add('current-day');
            }
          });
        });
      } catch(e) {
        console.error('Auto-fix day/period error:', e);
      }
    })();
  </script>
  {% block extra_js %}{% endblock %}
  <style>
    /* Global maroon outline for all cards across the site */
    .card, .auto-card, .table-card, .panel, .ds-card {
      border: 2px solid var(--maron-primary) !important;
      border-radius: 12px !important;
      background: #fff;
    }
  </style>

</body>
</html>
