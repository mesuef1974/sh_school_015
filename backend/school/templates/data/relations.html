{% extends "_base_maronia.html" %}
{% block title %}{{ title }}{% endblock %}
{% block content %}

<!-- Header Section -->
<div class="d-flex align-items-center justify-content-between mb-4" data-aos="fade-down">
  <div>
    <h1 class="h3 mb-2 d-flex align-items-center gap-3">
      <div class="icon-wrapper" style="background: linear-gradient(135deg, #7b1e1e 0%, #a52a2a 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
        <iconify-icon icon="solar:database-bold-duotone" width="28" style="color: white;"></iconify-icon>
      </div>
      <div>
        <div class="fw-bold">خريطة علاقات قاعدة البيانات</div>
        <div class="text-muted" style="font-size: 0.875rem; font-weight: 400;">عرض تفاعلي احترافي للعلاقات بين جداول النظام</div>
      </div>
    </h1>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-primary" href="{% url 'data_overview' %}" data-bs-toggle="tooltip" title="عرض كل الجداول">
      <iconify-icon icon="solar:list-bold-duotone" width="18"></iconify-icon>
      <span class="d-none d-md-inline ms-1">كل الجداول</span>
    </a>
    <div class="btn-group">
      <button id="btn-download-svg" class="btn btn-outline-secondary" type="button" data-bs-toggle="tooltip" title="تنزيل SVG">
        <iconify-icon icon="solar:file-text-bold-duotone" width="18"></iconify-icon>
        <span class="d-none d-lg-inline ms-1">SVG</span>
      </button>
      <button id="btn-download-png" class="btn btn-outline-secondary" type="button" data-bs-toggle="tooltip" title="تنزيل PNG">
        <iconify-icon icon="solar:gallery-bold-duotone" width="18"></iconify-icon>
        <span class="d-none d-lg-inline ms-1">PNG</span>
      </button>
    </div>
  </div>
</div>

<!-- Stats Cards -->
<div class="row g-3 mb-4" data-aos="fade-up">
  <div class="col-6 col-md-3">
    <div class="card h-100" style="background: linear-gradient(135deg, #7b1e1e 0%, #a52a2a 100%); border: none;">
      <div class="card-body text-white p-3">
        <div class="d-flex align-items-center gap-2 mb-2">
          <iconify-icon icon="solar:database-bold-duotone" width="24"></iconify-icon>
          <span class="small">قاعدة البيانات</span>
        </div>
        <div class="h5 mb-0 fw-bold">{% if db_info %}{{ db_info.vendor|upper }}{% else %}—{% endif %}</div>
        <div class="small opacity-75">{% if db_info %}{{ db_info.name }}{% else %}—{% endif %}</div>
      </div>
    </div>
  </div>

  <div class="col-6 col-md-3">
    <div class="card h-100" style="background: linear-gradient(135deg, #6a4c93 0%, #8b6fb0 100%); border: none;">
      <div class="card-body text-white p-3">
        <div class="d-flex align-items-center gap-2 mb-2">
          <iconify-icon icon="solar:server-bold-duotone" width="24"></iconify-icon>
          <span class="small">الإصدار</span>
        </div>
        <div class="h6 mb-0 fw-bold text-truncate" style="max-width: 100%;">{% if db_info and db_info.version %}{{ db_info.version|truncatechars:20 }}{% else %}—{% endif %}</div>
      </div>
    </div>
  </div>

  <div class="col-6 col-md-3">
    <div class="card h-100" style="background: linear-gradient(135deg, #c1666b 0%, #d4737c 100%); border: none;">
      <div class="card-body text-white p-3">
        <div class="d-flex align-items-center gap-2 mb-2">
          <iconify-icon icon="solar:shield-check-bold-duotone" width="24"></iconify-icon>
          <span class="small">القيود</span>
        </div>
        <div class="h5 mb-0 fw-bold">{% if constraints %}{{ constraints|length }}{% else %}0{% endif %}</div>
        <div class="small opacity-75">Constraints</div>
      </div>
    </div>
  </div>

  <div class="col-6 col-md-3">
    <div class="card h-100" style="background: linear-gradient(135deg, #48a9a6 0%, #5dbebb 100%); border: none;">
      <div class="card-body text-white p-3">
        <div class="d-flex align-items-center gap-2 mb-2">
          <iconify-icon icon="solar:layers-bold-duotone" width="24"></iconify-icon>
          <span class="small">الفهارس</span>
        </div>
        <div class="h5 mb-0 fw-bold">{% if indexes %}{{ indexes|length }}{% else %}0{% endif %}</div>
        <div class="small opacity-75">Indexes</div>
      </div>
    </div>
  </div>
</div>

<!-- Main Diagram Card -->
<div class="card shadow-sm mb-4" data-aos="fade-up" data-aos-delay="100">
  <div class="card-header bg-white border-bottom py-3">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
      <div class="d-flex align-items-center gap-2">
        <iconify-icon icon="solar:diagram-up-bold-duotone" width="24" style="color: var(--maron-primary);"></iconify-icon>
        <span class="fw-bold">مخطط العلاقات التفاعلي</span>
      </div>
      <div class="d-flex align-items-center gap-2">
        <div class="input-group input-group-sm" style="max-width: 280px;">
          <span class="input-group-text bg-light border-0">
            <iconify-icon icon="solar:magnifer-bold-duotone" width="16"></iconify-icon>
          </span>
          <input id="er-search" class="form-control border-0 bg-light" placeholder="ابحث عن جدول..."/>
        </div>
        <button id="btn-rerender" class="btn btn-sm btn-light" type="button" data-bs-toggle="tooltip" title="إعادة التوليد">
          <iconify-icon icon="solar:refresh-bold-duotone" width="18"></iconify-icon>
        </button>
      </div>
    </div>
  </div>

  <div class="card-body p-0">
    <div class="position-relative bg-light" style="min-height: 500px;">
      <div id="er-loading" class="position-absolute top-50 start-50 translate-middle text-center">
        <div class="spinner-border text-primary mb-2" role="status">
          <span class="visually-hidden">جاري التحميل...</span>
        </div>
        <div class="text-muted small">جاري توليد المخطط...</div>
      </div>
      <div id="er-wrap" class="p-4 overflow-auto" dir="ltr" style="min-height: 500px;">
        <pre class="mermaid" id="er-src" style="white-space: pre;">{{ mermaid }}</pre>
      </div>
    </div>
  </div>

  <div class="card-footer bg-white border-top py-3">
    <div class="row g-3 align-items-center">
      <div class="col-12 col-lg-8">
        <div class="d-flex flex-wrap gap-2 small">
          <span class="badge" style="background: linear-gradient(135deg, #7b1e1e 0%, #a52a2a 100%); color: white; padding: 0.5rem 0.75rem;">
            <iconify-icon icon="solar:link-bold-duotone" width="14" class="me-1"></iconify-icon>
            FK: مفتاح أجنبي
          </span>
          <span class="badge" style="background: linear-gradient(135deg, #6a4c93 0%, #8b6fb0 100%); color: white; padding: 0.5rem 0.75rem;">
            <iconify-icon icon="solar:double-alt-arrow-right-bold-duotone" width="14" class="me-1"></iconify-icon>
            O2O: واحد-لواحد
          </span>
          <span class="badge" style="background: linear-gradient(135deg, #48a9a6 0%, #5dbebb 100%); color: white; padding: 0.5rem 0.75rem;">
            <iconify-icon icon="solar:copy-bold-duotone" width="14" class="me-1"></iconify-icon>
            M2M: متعدد-لمتعدد
          </span>
        </div>
      </div>
      <div class="col-12 col-lg-4">
        <div class="d-flex gap-2 justify-content-lg-end">
          <button id="btn-copy-src" class="btn btn-sm btn-outline-secondary" type="button">
            <iconify-icon icon="solar:copy-bold-duotone" width="16"></iconify-icon>
            <span class="ms-1">نسخ الكود</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Details Section -->
{% if constraints or indexes %}
<div class="row g-4" data-aos="fade-up" data-aos-delay="200">
  <!-- Constraints -->
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-white border-bottom py-3">
        <div class="d-flex align-items-center gap-2">
          <iconify-icon icon="solar:shield-check-bold-duotone" width="24" style="color: var(--maron-primary);"></iconify-icon>
          <span class="fw-bold">القيود (Constraints)</span>
          {% if constraints %}
          <span class="badge bg-primary ms-auto">{{ constraints|length }}</span>
          {% endif %}
        </div>
      </div>
      <div class="card-body p-0">
        {% if constraints %}
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th class="small fw-semibold">الجدول</th>
                  <th class="small fw-semibold">الاسم</th>
                  <th class="small fw-semibold">التعريف</th>
                </tr>
              </thead>
              <tbody class="small">
                {% for c in constraints|slice:":20" %}
                <tr>
                  <td><code class="text-primary">{{ c.table }}</code></td>
                  <td class="text-muted">{{ c.name|truncatechars:30 }}</td>
                  <td dir="ltr" class="font-monospace small text-truncate" style="max-width: 200px;">{{ c.def|truncatechars:40 }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% if constraints|length > 20 %}
          <div class="card-footer bg-light text-center py-2">
            <small class="text-muted">وأكثر من {{ constraints|length|add:"-20" }} آخرين...</small>
          </div>
          {% endif %}
        {% else %}
          <div class="p-4 text-center text-muted">
            <iconify-icon icon="solar:folder-open-bold-duotone" width="48" class="mb-2 opacity-50"></iconify-icon>
            <div>لا توجد قيود متاحة</div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Indexes -->
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-white border-bottom py-3">
        <div class="d-flex align-items-center gap-2">
          <iconify-icon icon="solar:layers-bold-duotone" width="24" style="color: var(--maron-primary);"></iconify-icon>
          <span class="fw-bold">الفهارس (Indexes)</span>
          {% if indexes %}
          <span class="badge bg-primary ms-auto">{{ indexes|length }}</span>
          {% endif %}
        </div>
      </div>
      <div class="card-body p-0">
        {% if indexes %}
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th class="small fw-semibold">الجدول</th>
                  <th class="small fw-semibold">الاسم</th>
                  <th class="small fw-semibold">التعريف</th>
                </tr>
              </thead>
              <tbody class="small">
                {% for i in indexes|slice:":20" %}
                <tr>
                  <td><code class="text-primary">{{ i.table }}</code></td>
                  <td class="text-muted">{{ i.name|truncatechars:30 }}</td>
                  <td dir="ltr" class="font-monospace small text-truncate" style="max-width: 200px;">{{ i.def|truncatechars:40 }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% if indexes|length > 20 %}
          <div class="card-footer bg-light text-center py-2">
            <small class="text-muted">وأكثر من {{ indexes|length|add:"-20" }} آخرين...</small>
          </div>
          {% endif %}
        {% else %}
          <div class="p-4 text-center text-muted">
            <iconify-icon icon="solar:folder-open-bold-duotone" width="48" class="mb-2 opacity-50"></iconify-icon>
            <div>لا توجد فهارس متاحة</div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}

<style>
/* Modern Card Styling */
.card {
  border-radius: 12px;
  overflow: hidden;
}

.card-header, .card-footer {
  border-radius: 0 !important;
}

/* ER Diagram Styling */
#er-wrap svg {
  width: 100%;
  height: 100%;
  min-height: 450px;
}

/* Search Highlight */
#er-wrap svg g.match rect {
  stroke: #28a745 !important;
  stroke-width: 3px !important;
  filter: drop-shadow(0 0 8px rgba(40, 167, 69, 0.5));
}

#er-wrap svg g.match text {
  fill: #28a745 !important;
  font-weight: 700;
}

/* Smooth Transitions */
.btn, .badge, .card {
  transition: all 0.2s ease;
}

.btn:hover {
  transform: translateY(-2px);
}

/* Table Styling */
.table > :not(caption) > * > * {
  padding: 0.75rem 1rem;
}

.table-hover tbody tr:hover {
  background-color: rgba(123, 30, 30, 0.05);
}

/* Loading Animation */
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Print Styles */
@media print {
  .btn, .input-group, .badge {
    display: none !important;
  }
  #er-wrap {
    height: auto !important;
    overflow: visible !important;
  }
  .card {
    box-shadow: none !important;
    break-inside: avoid;
  }
}

/* Responsive */
@media (max-width: 768px) {
  #er-wrap {
    min-height: 350px;
  }

  .h3 {
    font-size: 1.25rem;
  }

  .icon-wrapper {
    width: 40px !important;
    height: 40px !important;
  }
}
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.4/dist/mermaid.min.js"></script>
<script>
(function(){
  // Initialize Mermaid
  if (window.mermaid) {
    mermaid.initialize({
      startOnLoad: true,
      securityLevel: 'strict',
      theme: 'default',
      themeVariables: {
        primaryColor: '#7b1e1e',
        primaryTextColor: '#fff',
        primaryBorderColor: '#a52a2a',
        lineColor: '#7b1e1e',
        secondaryColor: '#f8f9fa',
        tertiaryColor: '#fff'
      }
    });
  }

  const loading = document.getElementById('er-loading');
  function hideLoading(){
    if (loading) {
      loading.style.opacity = '0';
      loading.style.transition = 'opacity 0.3s';
      setTimeout(() => loading.style.display = 'none', 300);
    }
  }

  if (document.readyState === 'complete') {
    requestAnimationFrame(hideLoading);
  } else {
    window.addEventListener('load', () => requestAnimationFrame(hideLoading));
  }

  // Metadata Helper
  function withMetadata(svgText){
    try {
      const doc = new DOMParser().parseFromString(svgText, 'image/svg+xml');
      const m = doc.createElementNS('http://www.w3.org/2000/svg','metadata');
      m.textContent = `DB: {{ db_info.name|default:'-' }} | Engine: {{ db_info.vendor|default:'-' }} | Version: {{ db_info.version|default:'' }} | Generated: ${new Date().toISOString()}`;
      doc.documentElement.insertBefore(m, doc.documentElement.firstChild);
      return new XMLSerializer().serializeToString(doc);
    } catch { return svgText; }
  }

  // Download SVG
  document.getElementById('btn-download-svg')?.addEventListener('click', async function(){
    const pre = document.getElementById('er-src');
    const src = pre ? (pre.innerText || pre.textContent || '') : '';
    if (window.mermaid && typeof window.mermaid.render === 'function' && src.trim().length > 0) {
      try {
        const out = await window.mermaid.render('er-diagram-export', src);
        let svgText = out.svg;

        if (typeof DOMParser !== 'undefined') {
          const doc = new DOMParser().parseFromString(svgText, 'image/svg+xml');
          const svgEl = doc.documentElement;
          if (!svgEl.getAttribute('viewBox')) {
            const w = parseFloat(svgEl.getAttribute('width')) || 1200;
            const h = parseFloat(svgEl.getAttribute('height')) || 800;
            svgEl.setAttribute('viewBox', `0 0 ${w} ${h}`);
            svgEl.removeAttribute('width');
            svgEl.removeAttribute('height');
            svgText = new XMLSerializer().serializeToString(svgEl);
          }
        }

        svgText = withMetadata(svgText);
        const blob = new Blob([svgText], {type: 'image/svg+xml'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'db_relations.svg';
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 500);
        return;
      } catch (e) {
        console.warn('mermaid.render export failed', e);
      }
    }

    // Fallback
    const svg = document.querySelector('#er-wrap svg');
    if(!svg){ alert('الرسم غير جاهز بعد.'); return; }

    try {
      if (!svg.getAttribute('viewBox')) {
        const bbox = svg.getBBox();
        if (bbox && isFinite(bbox.width) && isFinite(bbox.height)) {
          svg.setAttribute('viewBox', `${bbox.x} ${bbox.y} ${bbox.width} ${bbox.height}`);
        }
      }
    } catch(_) {}

    let xml = new XMLSerializer().serializeToString(svg);
    xml = withMetadata(xml);
    const blob = new Blob([xml], {type: 'image/svg+xml'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'db_relations.svg';
    a.click();
    setTimeout(() => URL.revokeObjectURL(url), 500);
  });

  // Download PNG
  document.getElementById('btn-download-png')?.addEventListener('click', async function(){
    const svg = document.querySelector('#er-wrap svg');
    if(!svg){ alert('لم يتم توليد الرسم بعد'); return; }

    try{
      if(!svg.getAttribute('viewBox')){
        const bb = svg.getBBox();
        svg.setAttribute('viewBox',`${bb.x} ${bb.y} ${bb.width} ${bb.height}`);
      }
      svg.removeAttribute('width');
      svg.removeAttribute('height');

      const xml = new XMLSerializer().serializeToString(svg);
      const urlSvg = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(xml);
      const img = new Image();

      img.onload = function(){
        const scale = 2;
        const canvas = document.createElement('canvas');
        canvas.width = this.width * scale;
        canvas.height = this.height * scale;
        const ctx = canvas.getContext('2d');
        ctx.scale(scale, scale);
        ctx.drawImage(this, 0, 0);

        canvas.toBlob(b => {
          if(!b){ alert('تعذّر إنشاء PNG'); return; }
          const url = URL.createObjectURL(b);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'db_relations.png';
          a.click();
          setTimeout(() => URL.revokeObjectURL(url), 1000);
        });
      };

      img.onerror = () => alert('تعذّر تحميل الرسم كصورة');
      img.src = urlSvg;
    } catch(e){
      alert('تعذّر إنشاء PNG');
    }
  });

  // Copy Source
  document.getElementById('btn-copy-src')?.addEventListener('click', function(){
    const pre = document.getElementById('er-src');
    if(!pre){ alert('غير متاح الآن'); return; }
    const text = pre.innerText || pre.textContent || '';

    navigator.clipboard.writeText(text).then(() => {
      const originalText = this.innerHTML;
      this.innerHTML = '<iconify-icon icon="solar:check-circle-bold-duotone" width="16"></iconify-icon> <span class="ms-1">تم النسخ</span>';
      setTimeout(() => this.innerHTML = originalText, 1500);
    }).catch(() => alert('تعذّر النسخ'));
  });

  // Search Highlight
  (function(){
    const inp = document.getElementById('er-search');
    const wrap = document.getElementById('er-wrap');

    function highlight(q){
      const svg = wrap?.querySelector('svg');
      if(!svg) return;

      svg.querySelectorAll('g.match').forEach(el => el.classList.remove('match'));
      if(!q) return;

      const texts = svg.querySelectorAll('text');
      texts.forEach(t => {
        const name = (t.textContent || '').toLowerCase();
        if (name.includes(q.toLowerCase())) {
          const g = t.closest('g');
          g && g.classList.add('match');
        }
      });
    }

    let t;
    inp?.addEventListener('input', () => {
      clearTimeout(t);
      t = setTimeout(() => highlight(inp.value), 200);
    });
  })();

  // Re-render
  (function(){
    let busy = false;
    document.getElementById('btn-rerender')?.addEventListener('click', async function(){
      if (busy || !window.mermaid) return;
      busy = true;
      this.disabled = true;

      const originalHTML = this.innerHTML;
      this.innerHTML = '<iconify-icon icon="solar:refresh-bold-duotone" width="18" class="spin"></iconify-icon>';

      const pre = document.getElementById('er-src');
      const container = document.getElementById('er-wrap');
      container.querySelectorAll('svg').forEach(el => el.remove());

      try {
        await mermaid.init(undefined, pre);
      } catch(e){
        alert('تعذّر التوليد');
      }

      this.innerHTML = originalHTML;
      this.disabled = false;
      busy = false;
    });
  })();
})();
</script>

<style>
@keyframes spin {
  to { transform: rotate(360deg); }
}
.spin {
  animation: spin 1s linear infinite;
}
</style>
{% endblock %}
