{% extends "_base_maronia.html" %}
{% block title %}تدقيق قاعدة البيانات — أفضل الممارسات{% endblock %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3 page-header" data-aos="fade-down">
  <div>
    <h1 class="h4 mb-1 d-flex align-items-center gap-2">
      <lord-icon src="https://cdn.lordicon.com/oqdmuxru.json" trigger="hover" colors="primary:#7b1e1e,secondary:#c49a6c" style="width:36px;height:36px"></lord-icon>
      تدقيق قاعدة البيانات — أفضل الممارسات
    </h1>
    <div class="text-muted small">فحص آلي وخفيف يقترح تحسينات احترافية على المخطط والفهارس</div>
  </div>
  <div class="btn-group" role="group">
    <a class="btn btn-sm btn-outline-primary" href="{% url 'data_overview' %}" data-bs-toggle="tooltip" data-bs-title="عرض كل الجداول"><i class="bi bi-table"></i> <span class="d-none d-sm-inline">كل الجداول</span></a>
    <a class="btn btn-sm btn-outline-secondary" href="{% url 'data_relations' %}" data-bs-toggle="tooltip" data-bs-title="خريطة العلاقات"><i class="bi bi-diagram-3"></i> <span class="d-none d-sm-inline">خريطة العلاقات</span></a>
  </div>
</div>

<div class="card p-2 p-md-3" data-aos="fade-up">
  {% if suggestions_core_count|default:0 == 0 %}
  <div class="alert alert-success small mb-2" role="alert">تم تطبيق كل المقترحات الأساسية بنجاح — لا توجد اقتراحات أساسية حالياً.</div>
  {% endif %}
  <div class="row g-3 mb-3">
    <div class="col-12 col-lg-6">
      <div class="p-2 border rounded-3 bg-light h-100 small">
        <div><span class="text-muted">المحرك:</span> <strong>{{ db_info.vendor|default:'—' }}</strong></div>
        <div><span class="text-muted">قاعدة البيانات:</span> <strong>{{ db_info.name|default:'—' }}</strong></div>
        <div class="text-truncate" title="{{ db_info.version|default:'' }}"><span class="text-muted">الإصدار:</span> <strong>{{ db_info.version|default:'—' }}</strong></div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="p-2 border rounded-3 bg-light h-100 small">
        <div><span class="text-muted">تاريخ التدقيق:</span> <strong>{{ now }}</strong></div>
        <div><span class="text-muted">عدد الفحوصات:</span> <strong>{{ checks_total }}</strong></div>
        <div><span class="text-muted">المطابق:</span> <strong class="text-success">{{ checks_ok }}</strong> — <span class="text-muted">الاقتراحات:</span> <strong class="text-danger">{{ checks_warn }}</strong></div>
        <div class="mt-1 text-muted">اتصل مباشرة بنفس إعدادات المشروع: <code>psql -h {{ db_info.host|default:'127.0.0.1' }} -p {{ db_info.port|default:'5432' }} -U {{ db_info.user|default:'postgres' }} -d {{ db_info.name|default:'your_db' }}</code></div>
      </div>
    </div>
</div>

<!-- تنفيذ عملي: كيف أطبق التحسينات الآن؟ -->
<div class="alert alert-info small" role="alert">
  كيف أنفّذ التحسينات؟ اتبع الخطوات أدناه. هذه الخطوات آمنة ومجرّبة على PostgreSQL.
</div>
<div class="border rounded-3 p-3 mb-3">
  <h2 class="h6 mb-2">كيف أنفّذ التحسينات (PostgreSQL)</h2>
  <ol class="small mb-2">
    <li class="mb-2">نسخة احتياطية سريعة (اختياري لكن مستحسن)
      <div class="position-relative">
        <pre class="bg-light p-2 rounded copy-src" dir="ltr">pg_dump -h {{ db_info.host|default:'127.0.0.1' }} -p {{ db_info.port|default:'5432' }} -U {{ db_info.user|default:'postgres' }} -d {{ db_info.name|default:'your_db' }} -Fc -f backup_{{ db_info.name|default:'db' }}.dump</pre>
        <button class="btn btn-sm btn-outline-secondary copy-btn" type="button">نسخ</button>
      </div>
      <div class="mt-2 small text-muted">بدون مطالبة كلمة السر:
        <div class="position-relative mt-1">
          <pre class="bg-light p-2 rounded copy-src" dir="ltr">$env:PGPASSWORD=&quot;{{ db_info.password|default:'' }}&quot;; pg_dump -h {{ db_info.host|default:'127.0.0.1' }} -p {{ db_info.port|default:'5432' }} -U {{ db_info.user|default:'postgres' }} -d {{ db_info.name|default:'your_db' }} -Fc -f backup_{{ db_info.name|default:'db' }}.dump; Remove-Item Env:PGPASSWORD</pre>
          <button class="btn btn-sm btn-outline-secondary copy-btn" type="button" style="position:absolute; top:6px; inset-inline-end:6px;">نسخ</button>
        </div>
        <div class="position-relative mt-1">
          <pre class="bg-light p-2 rounded copy-src" dir="ltr">. .\scripts\pg_helpers.ps1; Backup-Db</pre>
          <button class="btn btn-sm btn-outline-secondary copy-btn" type="button" style="position:absolute; top:6px; inset-inline-end:6px;">نسخ</button>
        </div>
      </div>
    </li>
    <li class="mb-2">تطبيق الهجرات (تشمل القيود والفهارس المقترحة)
      <div class="position-relative">
        <pre class="bg-light p-2 rounded copy-src" dir="ltr">python backend/manage.py migrate</pre>
        <button class="btn btn-sm btn-outline-secondary copy-btn" type="button">نسخ</button>
      </div>
    </li>
    <li class="mb-2">تفعيل فهرس Trigram للأسماء (اختياري لتحسين البحث العربي)
      <div class="position-relative">
        <pre class="bg-light p-2 rounded copy-src" dir="ltr">psql -h {{ db_info.host|default:'127.0.0.1' }} -p {{ db_info.port|default:'5432' }} -U {{ db_info.user|default:'postgres' }} -d {{ db_info.name|default:'your_db' }} -c "CREATE EXTENSION IF NOT EXISTS pg_trgm;"</pre>
        <button class="btn btn-sm btn-outline-secondary copy-btn" type="button">نسخ</button>
      </div>
    </li>
    <li class="mb-2">تحقق سريع: أعد تحميل هذه الصفحة وتأكد أن العناصر ظهرت في قسم "مطابق لأفضل الممارسات" بدل "اقتراحات".</li>
  </ol>
  <div class="small text-muted">استعادة النسخة (عند الحاجة): <code>pg_restore -h 127.0.0.1 -U postgres -d {{ db_info.name|default:'your_db' }} --clean backup.dump</code></div>
</div>

<div class="row g-3">
  <div class="col-12 col-xl-6">
    <div class="border rounded-3 p-2">
      <h2 class="h6 mb-2">مطابق لأفضل الممارسات</h2>
      {% if passes %}
        <ul class="list-group list-group-flush small">
          {% for it in passes %}
            <li class="list-group-item d-flex justify-content-between align-items-start">
              <div class="me-2">
                <div class="fw-bold">{{ it.title }}</div>
                <div class="text-muted">{{ it.detail }}</div>
              </div>
              <span class="badge bg-success-subtle text-success">مطابق</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="text-muted small">لا يوجد عناصر حالياً.</div>
      {% endif %}
    </div>
  </div>
  <div class="col-12 col-xl-6">
    <div class="border rounded-3 p-2">
      <h2 class="h6 mb-2">اقتراحات تحسين</h2>
      {% if suggestions %}
        <ul class="list-group list-group-flush small">
          {% for it in suggestions %}
            <li class="list-group-item">
              <div class="d-flex justify-content-between align-items-start">
                <div class="me-2">
                  <div class="fw-bold">{{ it.title }}</div>
                  <div class="text-muted">{{ it.detail }}</div>
                </div>
                {% if it.optional %}
                <span class="badge bg-info-subtle text-info">اختياري</span>
                {% else %}
                <span class="badge bg-danger-subtle text-danger">اقتراح أساسي</span>
                {% endif %}
              </div>
              {% if it.hint %}
                <div class="position-relative">
                  <pre class="mt-2 mb-0 bg-light p-2 rounded copy-src" dir="ltr" style="white-space: pre-wrap; font-size: 12px;">{{ it.hint }}</pre>
                  <button class="btn btn-sm btn-outline-secondary copy-btn" type="button" style="position:absolute; top:6px; inset-inline-end:6px;">نسخ</button>
                </div>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="text-muted small">لا توجد اقتراحات — رائع!</div>
      {% endif %}
    </div>
  </div>
</div>

<div class="mt-3 small text-muted">
  ملاحظة: هذا التدقيق لا يُجري تغييرات تلقائياً؛ الهدف تزويدك برؤية وتحسينات عملية. بعض الفحوصات تتطلب PostgreSQL تحديداً.
</div>
</div>

{% block extra_js %}
{{ block.super }}
<script>
(function(){
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.copy-btn');
    if(!btn) return;
    const pre = btn.parentElement.querySelector('.copy-src');
    if(!pre) return;
    const text = pre.innerText || pre.textContent || '';
    navigator.clipboard.writeText(text).then(()=>{
      btn.textContent = 'نُسخ';
      setTimeout(()=>btn.textContent='نسخ', 1500);
    }).catch(()=>{ alert('تعذّر النسخ'); });
  });
})();
</script>
{% endblock %}
{% endblock %}