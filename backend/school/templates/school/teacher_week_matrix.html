{% extends "_base_maronia.html" %}
{% load static %}
{% load school_extras %}
{% block title %}{{ title }}{% endblock %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3 page-header">
  <h1 class="h5 mb-0">{% if read_only %}جدولي الأسبوعي{% else %}جدول المعلمين الأسبوعي (المعلم × الأيام × الحصص){% endif %}</h1>
  <div class="btn-group" role="group">
    {% if not read_only %}
    <a class="btn btn-sm btn-outline-primary" href="{% url 'teacher_class_matrix' %}">مصفوفة الأنصبة</a>
    {% endif %}
    <a class="btn btn-sm btn-outline-secondary" href="{% url 'teacher_week_compact' %}">عرض مضغوط للطباعة</a>
  </div>
</div>

<div class="card p-2 p-md-3">
  <div class="mb-2 small text-muted">
    {% if read_only %}
      عرض فقط — لا يمكن إضافة أو تحريك الحصص.
    {% else %}
      انقر لإضافة حصة في خانة فارغة، أو اسحب الحصة بين الخانات لتحريكها. الألوان حسب المادة.
    {% endif %}
  </div>
  <div class="tw-grid-wrap">
    <table class="table table-bordered align-middle text-center w-100 tw-table" dir="rtl">
      <thead class="table-light sticky-top">
        <tr>
          <th class="text-start sticky-right" style="min-width:220px; position:sticky; right:0; z-index:3; background:#fff;">المعلّم</th>
          {% for d in DAYS %}
            <th class="day-idx-{{ forloop.counter0 }} {% if forloop.first %}day-first{% elif forloop.last %}day-last{% endif %}">{{ DAY_NAMES|get_attr:d }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for t in teachers %}
          <tr>
            <th class="text-start" style="position:sticky; right:0; background:inherit; z-index:1;">
              <span class="tw-teacher-name">{{ t.full_name }}</span>
            </th>
            {% for d in DAYS %}
              <td class="day-idx-{{ forloop.counter0 }} {% if forloop.first %}day-first{% elif forloop.last %}day-last{% endif %}">
                <div class="tw-day-col" data-teacher="{{ t.id }}" data-day="{{ d }}">
                  {% for p in PERIODS %}
                    {% with e=grid|get_attr:t.id|get_attr:d|get_attr:p %}
                    <div class="tw-slot" data-period="{{ p }}" data-day="{{ d }}" data-teacher="{{ t.id }}" data-empty="{% if not e %}1{% else %}0{% endif %}">
                      <div class="tw-slot-head">ح{{ p }}</div>
                      {% if e %}
                        <div class="tw-item"{% if not read_only %} draggable="true"{% endif %} data-entry-id="{{ e.id }}" title="{{ e.subject.name_ar }} — {{ e.classroom.name }}">
                          <span class="tw-subj" style="background: {{ subject_colors|get_attr:e.subject_id }}">
                            {{ e.subject.name_ar }}
                          </span>
                          <span class="tw-class">{{ e.classroom.name }}</span>
                        </div>
                      {% else %}
                        {% if not read_only %}
                          <button type="button" class="btn btn-xs btn-outline-secondary tw-add-btn">+</button>
                        {% endif %}
                      {% endif %}
                    </div>
                    {% endwith %}
                  {% endfor %}
                </div>
              </td>
            {% endfor %}
          </tr>
        {% empty %}
          <tr><td colspan="6" class="text-muted">لا يوجد معلمون للعرض.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<style>
.tw-grid-wrap{ max-height: calc(100vh - 220px); overflow:auto; }
/* Darker grid lines and thick separators between days */
.tw-table>:not(caption)>*>* { border-color: #8a8f99 !important; }

.tw-day-col{ display:grid; grid-template-rows: repeat({{ PERIODS|length }}, 1fr); gap: 6px; }
.tw-slot{ position:relative; min-height:64px; padding:4px; border:1px dashed #cfd8dc; border-radius:6px; background:#fcfcfd; }
.tw-slot-head{ position:absolute; top:2px; inset-inline-start:4px; font-size:11px; color:#6b7280; }
.tw-item{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; height:100%; border-radius:4px; border:1px solid #b0bec5; background:#fff; {% if not read_only %}cursor:grab;{% else %}cursor:default;{% endif %} }
.tw-item:active{ cursor:grabbing; }
.tw-subj{ display:inline-block; padding:2px 6px; border-radius:999px; font-size:12px; }
.tw-class{ font-size:12px; color:#374151; }
.tw-slot.drop-ok{ outline:2px dashed #2e7d32; }
.btn.btn-xs{ --bs-btn-padding-y: .1rem; --bs-btn-padding-x: .25rem; --bs-btn-font-size: .75rem; }
/* Bigger teacher name (3x) */
.tw-teacher-name{ font-size:1.2rem; font-weight:600; line-height:1.1; display:inline-block; }

/* Day column pastel backgrounds (muted cool tones) */
.tw-table th.day-idx-0, .tw-table td.day-idx-0 { background-color: #fff7cc; } /* Yellow */
.tw-table th.day-idx-1, .tw-table td.day-idx-1 { background-color: #e6f4ea; } /* Green */
.tw-table th.day-idx-2, .tw-table td.day-idx-2 { background-color: #fde2e2; } /* Red */
.tw-table th.day-idx-3, .tw-table td.day-idx-3 { background-color: #e7f0ff; } /* Blue */
.tw-table th.day-idx-4, .tw-table td.day-idx-4 { background-color: #ffe8d1; } /* Orange */
.tw-table th.day-idx-5, .tw-table td.day-idx-5 { background-color: #efe7ff; } /* Purple */
.tw-table th.day-idx-6, .tw-table td.day-idx-6 { background-color: #e0f2fe; } /* Blue (again) */

/* Current period highlight */
.tw-slot.current-period {
  border: 2px solid #22c55e !important;
  box-shadow: 0 0 12px rgba(34, 197, 94, 0.4);
  background: #f0fdf4 !important;
}
</style>

<script>
// Highlight current period
(function(){
  try {
    const now = new Date();
    // Convert ISO weekday (Mon=1, Sun=7) to school format (Sun=1, Sat=7)
    const isoDow = now.getDay(); // Sun=0, Mon=1, Tue=2, Wed=3, Thu=4, Fri=5, Sat=6
    const schoolDow = (isoDow === 0) ? 1 : (isoDow + 1); // Sun=1, Mon=2, Tue=3, Wed=4, Thu=5, Fri=6, Sat=7

    // Only highlight for school days (Sun-Thu = 1-5)
    if (schoolDow < 1 || schoolDow > 5) return;

    // Get current time
    const hours = now.getHours();
    const minutes = now.getMinutes();
    const currentMinutes = hours * 60 + minutes;

    // Period times (matching your schedule)
    const periodTimes = [
      {period: 1, start: 7*60+15, end: 7*60+55},   // 07:15-07:55
      {period: 2, start: 8*60+0, end: 8*60+40},    // 08:00-08:40
      {period: 3, start: 8*60+45, end: 9*60+25},   // 08:45-09:25
      {period: 4, start: 9*60+50, end: 10*60+30},  // 09:50-10:30
      {period: 5, start: 10*60+35, end: 11*60+15}, // 10:35-11:15
      {period: 6, start: 11*60+20, end: 12*60+0},  // 11:20-12:00
      {period: 7, start: 12*60+5, end: 12*60+45}   // 12:05-12:45
    ];

    // Find current period
    let currentPeriod = null;
    for (const pt of periodTimes) {
      if (currentMinutes >= pt.start && currentMinutes <= pt.end) {
        currentPeriod = pt.period;
        break;
      }
    }

    if (!currentPeriod) return;

    // Highlight all slots matching current day and period
    const slots = document.querySelectorAll('.tw-slot');
    slots.forEach(slot => {
      const slotDay = parseInt(slot.getAttribute('data-day'));
      const slotPeriod = parseInt(slot.getAttribute('data-period'));
      if (slotDay === schoolDow && slotPeriod === currentPeriod) {
        slot.classList.add('current-period');
      }
    });
  } catch(e) {
    console.error('Current period highlight error:', e);
  }
})();
</script>
{% endblock %}

{% block extra_js %}
{% if not read_only %}
{{ subject_colors|json_script:"SUBJECT_COLORS" }}
<script>
(function(){
  const SUBJECT_COLORS = JSON.parse(document.getElementById('SUBJECT_COLORS').textContent || '{}');
  // Assign options per teacher
  const ASSIGN_OPTS = {
    {% for tid, opts in assign_opts.items %}
      "{{ tid }}": [
        {% for o in opts %}{"class_id": {{ o.class_id }}, "subject_id": {{ o.subject_id }}, "label": "{{ o.label }}"}{% if not forloop.last %}, {% endif %}{% endfor %}
      ]{% if not forloop.last %}, {% endif %}
    {% endfor %}
  };

  function getCookie(name){ const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m?m.pop():''; }

  function openAddModal(slotEl){
    const teacherId = slotEl.getAttribute('data-teacher');
    const day = slotEl.getAttribute('data-day');
    const period = slotEl.getAttribute('data-period');
    const opts = ASSIGN_OPTS[teacherId] || [];
    const html = `
      <div id="tw-modal" style="position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:1050;">
        <div style="background:#fff;min-width:360px;max-width:460px;padding:14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.25);">
          <div class="d-flex align-items-center justify-content-between mb-2"><strong>إضافة حصة</strong><button class="btn btn-sm btn-light" id="tw-close">×</button></div>
          <div class="mb-2"><label class="form-label">التكليف</label>
            <select class="form-select form-select-sm" id="tw-asg">
              ${opts.map(o=>`<option value="${o.class_id}|${o.subject_id}">${o.label}</option>`).join('')}
            </select>
          </div>
          <div class="text-end"><button id="tw-save" class="btn btn-primary btn-sm">حفظ</button></div>
        </div>
      </div>`;
    const wrap = document.createElement('div');
    wrap.innerHTML = html;
    document.body.appendChild(wrap);
    const overlay = document.getElementById('tw-modal');
    function close(){ overlay.remove(); }
    overlay.querySelector('#tw-close').onclick = close;
    overlay.querySelector('#tw-save').onclick = function(){
      const v = overlay.querySelector('#tw-asg').value || '';
      const [class_id, subject_id] = v.split('|');
      const form = new FormData();
      form.append('teacher_id', teacherId);
      form.append('classroom_id', class_id);
      form.append('subject_id', subject_id);
      form.append('day', day);
      form.append('period', period);
      fetch('{% url "api_timetable_add" %}', {
        method: 'POST', headers: {'X-Requested-With':'XMLHttpRequest','X-CSRFToken': getCookie('csrftoken')}, body: form
      }).then(r=>r.json()).then(data=>{
        if(!data.ok){ alert(data.error||'فشل الإضافة'); return; }
        // Replace slot content
        const e = data.entry;
        slotEl.innerHTML = `<div class="tw-slot-head">ح${e.period}</div>
          <div class="tw-item" draggable="true" data-entry-id="${e.id}" title="${e.subject} — ${e.classroom}">
            <span class="tw-subj" style="background: ${ (SUBJECT_COLORS[String(e.subject_id)] || SUBJECT_COLORS[e.subject_id] || '#e6f4ea') }">${e.subject}</span>
            <span class="tw-class">${e.classroom}</span>
          </div>`;
        close();
      }).catch(()=>alert('خطأ في الشبكة'));
    };
  }

  // Click to add
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.tw-add-btn');
    if (!btn) return;
    const slot = btn.closest('.tw-slot');
    openAddModal(slot);
  });

  // Drag and drop
  let dragEntryId = null;
  let dragSource = null;
  document.addEventListener('dragstart', function(e){
    const item = e.target.closest('.tw-item');
    if(!item) return;
    dragEntryId = item.getAttribute('data-entry-id');
    dragSource = item.closest('.tw-slot');
    e.dataTransfer.effectAllowed = 'move';
  });
  document.addEventListener('dragover', function(e){
    const slot = e.target.closest('.tw-slot');
    if(!slot) return;
    e.preventDefault();
    slot.classList.add('drop-ok');
  });
  document.addEventListener('dragleave', function(e){
    const slot = e.target.closest('.tw-slot');
    if(!slot) return;
    slot.classList.remove('drop-ok');
  });
  document.addEventListener('drop', function(e){
    const slot = e.target.closest('.tw-slot');
    if(!slot || !dragEntryId) return;
    e.preventDefault();
    const day = slot.getAttribute('data-day');
    const period = slot.getAttribute('data-period');
    const teacherId = slot.getAttribute('data-teacher');
    const form = new FormData();
    form.append('entry_id', dragEntryId);
    form.append('day', day);
    form.append('period', period);
    form.append('target_teacher_id', teacherId);
    fetch('{% url "api_timetable_move" %}', { method:'POST', headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken': getCookie('csrftoken')}, body: form })
      .then(r=>r.json()).then(data=>{
        if(!data.ok){ alert(data.error||'فشل النقل'); return; }
        const e = data.entry;
        // Clear destination slot and place item
        slot.classList.remove('drop-ok');
        slot.innerHTML = `<div class="tw-slot-head">ح${e.period}</div>
          <div class="tw-item" draggable="true" data-entry-id="${e.id}" title="${e.subject} — ${e.classroom}">
            <span class="tw-subj" style="background: ${ (SUBJECT_COLORS[String(e.subject_id)] || SUBJECT_COLORS[e.subject_id] || '#e6f4ea') }">${e.subject}</span>
            <span class="tw-class">${e.classroom}</span>
          </div>`;
        // Clear source slot if it still contains the dragged item
        if (dragSource && dragSource !== slot){
          const it = dragSource.querySelector('.tw-item');
          if (it && it.getAttribute('data-entry-id') === String(e.id)){
            dragSource.innerHTML = `<div class=\"tw-slot-head\">ح${dragSource.getAttribute('data-period')}</div><button type=\"button\" class=\"btn btn-xs btn-outline-secondary tw-add-btn\">+</button>`;
          }
        }
        dragEntryId = null; dragSource = null;
      }).catch(()=>alert('خطأ في الشبكة'));
  });
})();
</script>
{% endif %}
{% endblock %}

<!-- Modern UI overrides for teacher_week_matrix (safe, minimal) -->
<style>
/***** Modern look & feel (maroon brand) *****/
.tw-table { background: #fff; border-radius: 12px; overflow: hidden; }
.tw-table thead.table-light { background: #faf6f5 !important; }
.tw-table thead.table-light th { box-shadow: 0 2px 0 rgba(0,0,0,.04); }

/* Sticky header subtle shadow */
.tw-table thead.sticky-top { box-shadow: 0 6px 12px -6px rgba(0,0,0,.08); }

/* Sticky teacher column polish */
.tw-table .sticky-right { box-shadow: -6px 0 12px -6px rgba(0,0,0,.06); }

/* Softer slot visuals */
.tw-slot { background: #fff; border: 1px solid rgba(0,0,0,.06); border-radius: 10px; transition: box-shadow .15s ease, transform .08s ease;
}
.tw-slot:hover { box-shadow: 0 6px 18px rgba(0,0,0,.06); transform: translateY(-1px); }
.tw-slot-head { font-weight: 600; color:#6b7280; }

.tw-item { border: 1px solid rgba(0,0,0,.08); background: #fff; box-shadow: 0 1px 0 rgba(0,0,0,.04) inset; }
.tw-subj { font-weight: 700; letter-spacing: .2px; }
.tw-class { color:#374151; opacity:.9; }

/* Add button refinement */
.tw-add-btn { border-color: var(--maron-accent); color: var(--maron-accent); }
.tw-add-btn:hover { background: var(--maron-accent); color: #fff; }

/* Current period emphasis */
.tw-slot.current-period { border-color:#22c55e !important; background:#f0fdf4 !important; box-shadow: 0 0 0 2px #22c55e22; }

/* Day headers readability */
.tw-table th[class^="day-idx-"] { color:#4a2b2b; font-weight:700; }

/* Responsive: keep grid usable on mobile */
@media (max-width: 992px){
  .tw-grid-wrap{ max-height: none; }
  .tw-slot{ min-height: 56px; }
}
</style>