{% extends "_base_maronia.html" %}
{% block title %}مارونية — {{ title }}{% endblock %}
{% block content %}
  <div class="d-flex align-items-center justify-content-between mb-3 page-header">
    <h1 class="h4 mb-0">لوحة الأنصبة</h1>
    <div>
      <a class="btn btn-sm btn-outline-primary" href="{% url 'teacher_class_matrix' %}">عرض مصفوفة المعلّم × الصف</a>
    </div>
  </div>

  <!-- KPI cards -->
  <div class="row g-3 mb-3">
    <div class="col-6 col-md-3">
      <div class="card p-3 text-center">
        <div class="small text-muted">مجموع الحصص الأسبوعية</div>
        <div class="display-6 fw-bold">{{ kpi_weekly_total }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card p-3 text-center">
        <div class="small text-muted">تكليفات اليوم</div>
        <div class="display-6 fw-bold">{{ kpi_todays_assignments }}</div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="small text-muted">التغطية الإجمالية <span title="الفجوات = مواد مقرّرة بلا تكليف لمعلّم في صف معيّن." class="ms-1">ℹ︎</span></div>
          <div class="small">
            مغطى: {{ chart_coverage.covered }} • فجوات: {{ chart_coverage.gaps }}
          </div>
        </div>
        <canvas id="coverageChart" height="80"></canvas>
      </div>
    </div>
  </div>
  <div class="alert alert-success text-center py-2 mb-4" role="alert">
    اجمالي التكليفات: <strong>{{ kpi_weekly_total }}</strong>
    —
    {% if kpi_gaps_count and kpi_gaps_count|add:0 > 0 %}
      توجد <strong>{{ kpi_gaps_count }}</strong> فجوات.
      <span class="d-block small mt-1 text-muted">الفجوات تعني مواد مقرّرة لا يوجد لها معلّم مكلّف في صف معيّن.</span>
      <a class="btn btn-sm btn-outline-primary mt-2" href="{% url 'teacher_class_matrix' %}">أين هي الفجوات؟ اعرضها على المصفوفة</a>
    {% else %}
      لا توجد فجوات
    {% endif %}
  </div>

  {% if kpi_gaps_count and kpi_gaps_count|add:0 > 0 %}
  <div class="card p-3 mb-4">
    <h5 class="mb-2">أين الفجوات الآن؟</h5>
    <p class="small text-muted mb-2">المواد التالية بلا معلّم مكلّف لكل صف:</p>
    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle mb-0">
        <thead>
          <tr><th>الصف</th><th>الشعبة</th><th>المادة</th></tr>
        </thead>
        <tbody>
          {% for g in gaps_items %}
            <tr><td>{{ g.grade }}</td><td>{{ g.section }}</td><td>{{ g.subject }}</td></tr>
          {% empty %}
            <tr><td colspan="3" class="text-center text-muted">لا توجد فجوات</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <a class="btn btn-sm btn-outline-primary mt-3" href="{% url 'teacher_class_matrix' %}">عرض على مصفوفة المعلّم × الصف</a>
  </div>
  {% endif %}

  <div class="row g-4">
    <div class="col-lg-4">
      <div class="card p-3 form-section">
        <h5 class="mb-3">إضافة تكليف جديد</h5>
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="add" />
          <div class="mb-2">{{ form.teacher.label_tag }} {{ form.teacher }}</div>
          <div class="mb-2">{{ form.classroom.label_tag }} {{ form.classroom }}</div>
          <div class="mb-2">{{ form.subject.label_tag }} {{ form.subject }}</div>
          <div class="mb-2">{{ form.no_classes_weekly.label_tag }} {{ form.no_classes_weekly }}</div>
          <div class="mb-2">{{ form.notes.label_tag }} {{ form.notes }}</div>
          <button class="btn btn-maron mt-2">حفظ</button>
        </form>
      </div>

      <div class="card p-3 form-section mt-4">
        <h5 class="mb-3">استيراد من Excel</h5>
        {% if show_imports %}
          <!-- متزامن (فوري) -->
          <form method="post" enctype="multipart/form-data" class="mb-2">
            {% csrf_token %}
            <input type="hidden" name="action" value="upload" />
            <div class="mb-2">
              {{ upload_form.file.label_tag }}
              {{ upload_form.file }}
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" name="dry_run" value="1" id="chkDryRun1">
              <label class="form-check-label" for="chkDryRun1">تجربة بدون حفظ (Dry-run)</label>
            </div>
            <button class="btn btn-secondary">رفع واستيراد</button>
          </form>
          <!-- خلفية (RQ) -->
          <form method="post" enctype="multipart/form-data" class="mb-2">
            {% csrf_token %}
            <input type="hidden" name="action" value="upload_async" />
            <div class="mb-2">
              {{ upload_form.file.label_tag }}
              {{ upload_form.file }}
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" name="dry_run" value="1" id="chkDryRun1b">
              <label class="form-check-label" for="chkDryRun1b">تجربة بدون حفظ (Dry-run)</label>
            </div>
            <button class="btn btn-outline-primary">إرسال للاستيراد بالخلفية (لا يجمّد الصفحة)</button>
          </form>
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="upload_default" />
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" name="dry_run" value="1" id="chkDryRun2">
              <label class="form-check-label" for="chkDryRun2">تجربة بدون حفظ (Dry-run) عند الاستيراد من المسار الافتراضي</label>
            </div>
            <button class="btn btn-outline-secondary">استيراد من المسار الافتراضي DOC/school_DATA/schasual.xlsx</button>
          </form>
        {% else %}
          <div class="alert alert-info mb-0" role="alert">
            تم تعطيل الاستيراد مؤقتًا — البيانات الحالية جاهزة ويمكن إدارتها يدويًا هنا. لإعادة التمكين ضع DISABLE_IMPORTS=False في backend/.env.
          </div>
        {% endif %}
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="small text-muted">أعلى الأنصبة حسب المعلّم</div>
          <div class="small text-muted">(المصدر: المصفوفة)</div>
        </div>
        <canvas id="topTeachersChart" height="140"></canvas>
        <hr>
        {# تمت إزالة جميع أدوات الفلترة حسب الطلب — عرض الجدول كما كان بدون فلترة/فرز #}

        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="small text-muted">جدول التكليفات</div>
          <div>
            <a class="btn btn-sm btn-outline-success" href="/data/school_teachingassignment/export" target="_blank" rel="noopener" aria-label="تصدير التكليفات CSV">تصدير CSV</a>
          </div>
        </div>
        <div id="assignments">
          {% include 'school/_assignments_table.html' %}
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="small text-muted">التغطية حسب الصف (مغطى مقابل فجوات)</div>
          <div class="small text-muted">(المصدر: المصفوفة)</div>
        </div>
        <canvas id="coverageByGradeChart" height="120"></canvas>
      </div>
    </div>
  </div>

  {% block extra_js %}
    {{ block.super }}
    {{ chart_top_teachers_labels|json_script:"topTeachersLabels" }}
    {{ chart_top_teachers_values|json_script:"topTeachersValues" }}
    {{ chart_coverage|json_script:"coverageData" }}
    {{ chart_coverage_by_grade_labels|json_script:"covGradeLabels" }}
    {{ chart_coverage_by_grade_covered|json_script:"covGradeCovered" }}
    {{ chart_coverage_by_grade_gaps|json_script:"covGradeGaps" }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
    <script>
      (function() {
        const labels = JSON.parse(document.getElementById('topTeachersLabels').textContent || '[]');
        const values = JSON.parse(document.getElementById('topTeachersValues').textContent || '[]');
        const cov = JSON.parse(document.getElementById('coverageData').textContent || '{}');

        const ctx1 = document.getElementById('topTeachersChart');
        if (ctx1 && labels.length) {
          new Chart(ctx1, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'حصص أسبوعية',
                data: values,
                backgroundColor: 'rgba(123, 30, 30, 0.7)',
                borderColor: 'rgba(123, 30, 30, 1)',
                borderWidth: 1,
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              plugins: { legend: { display: false } },
              scales: { x: { beginAtZero: true } }
            }
          });
        }

        const ctx2 = document.getElementById('coverageChart');
        if (ctx2) {
          const gapsVal = Number(cov.gaps || 0);
          const coveredVal = Number(cov.covered || 0);
          // If there are no gaps at all, render a single-slice doughnut to avoid showing an empty "gaps" legend entry
          const labels2 = gapsVal > 0 ? ['مغطى', 'فجوات'] : ['مغطى'];
          const data2 = gapsVal > 0 ? [coveredVal, gapsVal] : [coveredVal];
          const colors2 = gapsVal > 0 ? ['#7b1e1e', '#c49a6c'] : ['#7b1e1e'];
          new Chart(ctx2, {
            type: 'doughnut',
            data: {
              labels: labels2,
              datasets: [{
                data: data2,
                backgroundColor: colors2
              }]
            },
            options: { plugins: { legend: { position: 'bottom' } } }
          });
        }

        // Coverage by grade (stacked bar)
        const gLabelsEl = document.getElementById('covGradeLabels');
        if (gLabelsEl) {
          const gLabels = JSON.parse(gLabelsEl.textContent || '[]');
          const gCovered = JSON.parse((document.getElementById('covGradeCovered')||{}).textContent || '[]');
          const gGaps = JSON.parse((document.getElementById('covGradeGaps')||{}).textContent || '[]');
          const ctx3 = document.getElementById('coverageByGradeChart');
          if (ctx3) {
            new Chart(ctx3, {
              type: 'bar',
              data: {
                labels: gLabels,
                datasets: [
                  { label: 'مغطى', data: gCovered, backgroundColor: 'rgba(13,110,253,0.7)' },
                  { label: 'فجوات', data: gGaps, backgroundColor: 'rgba(196,154,108,0.8)' },
                ]
              },
              options: {
                responsive: true,
                plugins: { legend: { position: 'bottom' } },
                scales: {
                  x: { stacked: true },
                  y: { stacked: true, beginAtZero: true }
                }
              }
            });
          }
        }
      })();
    </script>
  {% endblock %}
{% endblock %}