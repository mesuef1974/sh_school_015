<?xml version="1.0"?>
<configuration>
  <!--
    IIS configuration for optimal static asset delivery.
    - Enables gzip and brotli compression when available.
    - Adds long-term caching for hashed assets generated by Vite (files with .[hash]. in name).
    - Keeps HTML un-cached for up-to-date app shell.
  -->
  <system.web>
    <compilation debug="false" targetFramework="4.8" />
    <pages controlRenderingCompatibilityVersion="4.0" />
  </system.web>

  <system.webServer>
    <!-- Static compression (gzip) and dynamic compression if installed -->
    <httpCompression directory="%SystemDrive%\\inetpub\\temp\\IIS Temporary Compressed Files">
      <scheme name="gzip" dll="%Windir%\\system32\\inetsrv\\gzip.dll" />
      <!-- brotli if the module is available; harmless if missing -->
      <scheme name="br" dll="%Windir%\\system32\\inetsrv\\br.dll" />
      <dynamicTypes>
        <add mimeType="text/*" enabled="true" />
        <add mimeType="application/javascript" enabled="true" />
        <add mimeType="application/json" enabled="true" />
        <add mimeType="image/svg+xml" enabled="true" />
      </dynamicTypes>
      <staticTypes>
        <add mimeType="text/*" enabled="true" />
        <add mimeType="application/javascript" enabled="true" />
        <add mimeType="application/json" enabled="true" />
        <add mimeType="image/svg+xml" enabled="true" />
        <add mimeType="font/woff2" enabled="true" />
        <add mimeType="font/woff" enabled="true" />
      </staticTypes>
    </httpCompression>
    <urlCompression doStaticCompression="true" doDynamicCompression="true" />

    <!-- Cache policy: hashed assets immutable; HTML/JSON short cache -->
    <staticContent>
      <!-- Map common font types in case server lacks them -->
      <remove fileExtension=".woff2" />
      <mimeMap fileExtension=".woff2" mimeType="font/woff2" />
      <remove fileExtension=".woff" />
      <mimeMap fileExtension=".woff" mimeType="font/woff" />
    </staticContent>

    <httpProtocol>
      <customHeaders>
        <!-- Default: allow caching for static assets with hash in filename (vite) -->
        <add name="Cache-Control" value="public, max-age=600" />
      </customHeaders>
    </httpProtocol>

    <rewrite>
      <outboundRules>
        <!-- Set immutable caching for hashed assets (e.g., app.abc123.js, style.9f8e7.css) -->
        <rule name="AddLongCacheForHashedAssets" preCondition="IsHashedAsset">
          <match serverVariable="RESPONSE_Cache_Control" pattern=".*" />
          <action type="Rewrite" value="public, max-age=31536000, immutable" />
        </rule>
        <preConditions>
          <preCondition name="IsHashedAsset">
            <add input="{REQUEST_URI}" pattern="\.(?:js|css|woff2?|svg|png|jpg|jpeg|gif)\?*.*$" />
            <add input="{REQUEST_URI}" pattern="\.[0-9a-f]{8,}\." />
          </preCondition>
        </preConditions>
      </outboundRules>
    </rewrite>
  </system.webServer>
</configuration>
