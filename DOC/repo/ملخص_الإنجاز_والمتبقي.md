### ملخص تنفيذي للوضع الحالي للمنصة وما التالي

- التاريخ/الوقت: 2025-11-18 19:33

هذا المستند يقدّم ملخصًا تنفيذيًا مختصرًا ودقيقًا حول ما تم إنجازه في المنصة حتى الآن، وما الذي سيأتي لاحقًا، مع إبراز الأولويات والمخاطر وخطوات التنفيذ التالية.

#### 1) الوضع الحالي (What's Done)
- أعذار الغياب (المادة السابعة) — مكتمل وظيفيًا:
  - نماذج: Absence، ExcuseRequest، ExcuseAttachment.
  - REST: قراءة الغياب، إنشاء/مراجعة/اعتماد/رفض/استكمال الأعذار، ورفع المرفقات.
  - RBAC لدور «مشرف الجناح» عبر setup_phase1_attendance (مراجعة/تحويل «بعذر»/طلب الاستكمال).
  - سجل تدقيق ExcuseAuditLog ومنع المرفقات بعد القرار النهائي.

- الإجراءات Actions والمستندات الموقّعة — جاهزة:
  - نموذج Action وربطه بـ Incident.
  - مرفقات موقّعة عبر IncidentAttachment.action مع حساب SHA256 وتخزين mime/size.
  - تحديث doc_received_at تلقائيًا وسجل تدقيق للأحداث.

- كتالوج المخالفات وسُلّم الدرجات — مُهيأ:
  - discipline_seed_catalog يهيّئ BehaviorLevel (1–4) ومجموعة Violations أساسية (Idempotent).
  - تصعيد ديناميكي: compute_repeat_index (يفضّل Policy.window_days) + suggest_actions_for.
  - تضمين repeat_index و suggested_actions في IncidentSerializer.

- اللجنة وإشعار وليّ الأمر — مُنفّذ:
  - لجنة دائمة + جدولة لجنة الواقعة schedule-committee + قرار committee-decision مع صلاحيات تلقائية.
  - إشعار وليّ الأمر + تتبّع SLA (للدرجتين 1–2) عبر notify-guardian، وحقول تتبّع مرتبطة.

- سير عمل الواقعة (توسعة متوافقة للخلف):
  - حالات: Draft, Submitted, Review, Action Required, In Committee, Resolved, Closed مع الحفاظ على القيم القديمة.
  - تحسين submit لقبول open/draft مع status_display=review.
  - أفعال REST: require-action، route-committee، resolve، إضافةً إلى close/appeal/reopen.
  - IncidentAuditLog لكل الانتقالات + status_display مشتق للتطبيع.

- الإعدادات والاختبارات:
  - مواءمة بيئية (JWT/CORS/CSRF/DB و DISCIPLINE_*). قاعدة البيانات المعتمدة حصريًا: Postgres عبر DATABASE_URL.
  - اختبارات Pytest: الأعذار، صلاحيات/إدارة الإجراءات، مرفقات الإجراء، التصعيد (≥20 حالة)، إشعار وليّ الأمر + SLA.

#### 2) ما التالي (Roadmap المختصر)
- استكمال سير العمل واختباراته الشاملة:
  - حالات وانتقالات: DRAFT → SUBMITTED → REVIEW → ACTION_REQUIRED → IN_COMMITTEE → RESOLVED → CLOSED.
  - حراس RBAC لكل انتقال + IncidentAuditLog + نقاط API (submit/review/require-action/route-committee/resolve/close/reopen).

- الأدلة والمضبوطات (Phase 3):
  - Evidence مع chain_of_custody وحقول المصدر والالتقاط والميتا.
  - Confiscation بسير الضبط والتسليم وإيصال مرتبط بإجراء.
  - حماية صارمة لمرفقات الدرجة الرابعة وإخفاء بيانات حسّاسة.

- توسيع كتالوج المخالفات:
  - استكمال Violations بحسب الوثيقة المرجعية مع اختبارات idempotency.

- التقارير والمؤشرات (KPIs):
  - توزيع الوقائع حسب الدرجة/الحالة، امتثال SLA، التكرار، تحويلات الغياب.
  - واجهة REST للتقارير والتصدير.

- تحسينات واجهة أمامية (حدّ أدنى):
  - عرض repeat_index و suggested_actions وزر «إشعار وليّ الأمر» في IncidentForm/Card.
  - لوحة «مشرف الجناح» لإدارة ExcuseRequests.

- إحكام RBAC والخصوصية:
  - أذونات انتقالات سير العمل.
  - عزل تخزين مرفقات الدرجة الرابعة وتنقيح الاستجابات.

#### 3) الخطوات الفورية المقترحة (Next Actions)
1) تثبيت اختبارات سير العمل الموسّع وإغلاق الثغرات في الانتقالات.
2) تنفيذ نماذج Evidence/Confiscation تدريجيًا مع سياسات الوصول للدرجة الرابعة.
3) بناء نقاط التقارير الأساسية (SLA/الدرجات/التكرار) مع توثيق الاستخدام.
4) تحسينات واجهة أمامية محدودة لتمكين المشرفين من مهامهم اليومية.
5) تدقيق RBAC شامل وإضافة سياسات حماية للملفات الحساسة.

#### 4) المخاطر والتخفيف
- تعقيد سير العمل قد يسبب التباسًا: اعتماد status_display ثابت في الواجهات وتوثيق الانتقالات.
- حساسية بيانات الدرجة الرابعة: فصل التخزين والصلاحيات وتشفير النقل والتحقق من الصلاحيات في كل نقطة.
- اتساع الكتالوج: اختبارات idempotency ومهاجرات آمنة قابلة للإعادة.

- #### 5) تعليمات تشغيل سريعة (Dev/QA)
- تأكد أن Postgres يعمل محليًا (أو عبر Docker). مثال متغير البيئة في backend/.env:
  - DATABASE_URL=postgresql://postgres:postgres@127.0.0.1:5433/sh_school
  - ملاحظة: ملف infra/docker-compose.yml يعرّض Postgres على منفذ المضيف 5433 (إلى 5432 داخل الحاوية).
- ثم نفّذ:
  - python manage.py makemigrations discipline
  - python manage.py migrate
  - python manage.py discipline_seed_catalog
  - python manage.py setup_phase1_attendance
  - pytest -q tests/

ملاحظة: سكربت scripts/start_db.ps1 يقوم تلقائيًا بإنشاء حجم Docker الخارجي المطلوب (sh_school_pg_data) عند عدم وجوده، ثم يشغّل خدمة Postgres ويتحقق من الصحة والاتصال على المنفذ 5433.

#### 6) واجهات التقارير الجديدة (حضور/غياب)
- تمت إضافة نقاط REST لمشرف الجناح لإرجاع نسب الحضور/الغياب على مستويات الصف/الجناح/المدرسة مع تجميع زمني:
  - GET /api/attendance/wing/reports/classes?date=YYYY-MM-DD&group_by=day|week|month
  - GET /api/attendance/wing/reports/wings?date=YYYY-MM-DD&group_by=day|week|month
  - GET /api/attendance/wing/reports/school?date=YYYY-MM-DD&group_by=day|week|month
  - بديل الفترة: from=YYYY-MM-DD&to=YYYY-MM-DD بدلاً من date.
  - احترام الصلاحيات: يظهر فقط نطاق أجنحة المستخدم، ويمكن تحديد wing_id للمشرف الأعلى/المدير.
  - حقول الاستجابة لكل عنصر: total_students, absent_total, absent_excused, absent_unexcused, absent_pending, present, present_pct, absent_pct, date_bucket.
  - خيار اختياري: include_pending=1 لعرض الأعذار قيد المراجعة كمؤشر مستقل (pending) إلى جانب المبرر/غير المبرر.

##### إضافات وتحسينات (دفعة حالية)
- دعم group_by=term (فصلي) مع نقطة مساعدة للفصول: GET /api/attendance/wing/reports/terms.
- حارس صلاحيات للتقارير: يتطلّب attendance.report_view أو صلاحيات إدارية (staff/superuser).
- أمر إدارة لتحويل الغياب الجزئي إلى يوم كامل (قاعدة: غياب الحصة 1 و2):
  - python manage.py attendance_finalize_day --date=YYYY-MM-DD
  - Idempotent ويضيف Absence من نوع FULL_DAY تلقائيًا.
- مهلة أعذار «أيام عمل» وتعبئة due_at تلقائيًا:
  - إعدادات:
    - ATTENDANCE_EXCUSE_GRACE_DAYS (افتراضي 3)
    - ATTENDANCE_WORKWEEK (افتراضي SUN-THU)
  - عند إنشاء ExcuseRequest بنطاق تواريخ، تُحسب due_at كأقصى موعد بعد إضافة «أيام العمل» لكل يوم في النطاق.

#### 7) المراجع
- النماذج والمسارات: backend/discipline/models.py, serializers.py, views.py, urls.py
- أوامر التهيئة: backend/discipline/management/commands/
- الإعدادات: backend/core/settings_base.py (+ settings_dev.py)
- وثائق مرجعية: DOC/repo/اللائحة_السلوكية.md، هذا الملف.

#### 8) حالة التنفيذ (مختصرة)
- الإنجاز: مسار الأعذار، الإجراءات والمرفقات، التصعيد الديناميكي، إشعار وليّ الأمر + SLA، الكتالوج الأولي، RBAC وأوامر التهيئة، واختبارات أساسية — مكتمل.
- المتبقي: استكمال اختبارات سير العمل، Evidence/Confiscation وخصوصية الدرجة الرابعة، تقارير/KPIs، توسيع الكتالوج، وتحسينات واجهة — ضمن الدفعة التالية.
