### ملخص: ماذا أُنجِز وماذا بَقِي؟

#### 1) ما الذي أُنجِز (Back-end أولًا)
- أعذار الغياب (المادة السابعة) مكتملة:
  - نماذج: Absence، ExcuseRequest، ExcuseAttachment.
  - مسارات REST: قراءة الغياب، إنشاء/مراجعة/اعتماد/رفض/استكمال الأعذار، ورفع مرفقات العذر.
  - RBAC رسمي لدور «مشرف الجناح» عبر أمر التهيئة setup_phase1_attendance (أذونات المراجعة، التحويل إلى «بعذر»، طلب الاستكمال).
  - سجل تدقيق ExcuseAuditLog لكل العمليات، ومنع رفع المرفقات بعد القرار النهائي.

- الإجراءات Actions وإدارة المستندات الموقّعة:
  - نموذج Action وربطه بالواقعة Incident.
  - رفع مرفقات موقّعة مرتبطة مباشرةً بكل إجراء عبر IncidentAttachment.action، مع حساب SHA256 وتخزين mime/size.
  - تحديث doc_received_at تلقائيًا عند رفع المستند المطلوب، وسجلات تدقيق للأحداث.

- الكتالوج والسلالم:
  - أمر discipline_seed_catalog لتهيئة BehaviorLevel (1–4) ومجموعة Violations أساسية (Idempotent).
  - منطق تصعيد ديناميكي: compute_repeat_index (يُفضّل Violation.policy.window_days ثم إعداد البيئة) + suggest_actions_for.
  - إرجاع repeat_index و suggested_actions ضمن تمثيل الواقعة عبر IncidentSerializer.

- اللجنة وإشعار وليّ الأمر:
  - لجنة دائمة + جدولة لجنة الواقعة schedule-committee + قرار اللجنة committee-decision مع منح صلاحيات تلقائي للمشاركين.
  - إشعار وليّ الأمر + تتبّع SLA للدرجتين 1–2 عبر endpoint notify-guardian، مع حقول notified_guardian_at وguardian_notify_channel وguardian_notify_sla_met وسجل تدقيق.

- سير عمل الواقعة (مُوسَّع + توافق خلفي):
  - حالات موسّعة: Draft, Submitted, Review, Action Required, In Committee, Resolved, Closed مع الحفاظ على القيم القديمة (open/under_review/closed).
  - تحسين submit لقبول open/draft مع إبقاء القيمة الداخلية under_review (وتوفير status_display=review للواجهات).
  - أفعال REST جديدة: require-action، route-committee، resolve، إضافةً إلى close/appeal/reopen القائمة.
  - تسجيل IncidentAuditLog لجميع الانتقالات، بما فيها close/appeal/reopen.
  - حقل مشتق status_display في تمثيل Incident لتطبيع العرض (open→draft، under_review→review) دون تغيير قاعدة البيانات.

- الإعدادات والبيئة والاختبارات:
  - مواءمة إعدادات البيئة (JWT/CORS/CSRF/DB وDISCIPLINE_*). دعم DATABASE_URL بما فيه SQLite للتطوير السريع.
  - اختبارات Pytest شاملة: الأعذار، صلاحيات/إدارة الإجراءات، مرفقات الإجراء، التصعيد (≥20 حالة)، إشعار وليّ الأمر + SLA.

#### 2) ما الذي بَقِي (حسب الخارطة الموحّدة)
- توسيع سير عمل الواقعة Incident:
  - حالات وانتقالات: DRAFT → SUBMITTED → REVIEW → ACTION_REQUIRED → IN_COMMITTEE → RESOLVED → CLOSED.
  - حراس RBAC لكل انتقال + IncidentAuditLog لكل خطوة + نقاط API (submit/review/require-action/route-committee/resolve/close/reopen). [تم تنفيذ الجزء الأكبر؛ تبقى اختبارات شاملة]

- الأدلة والمضبوطات (مرحلة 3):
  - Evidence مع chain_of_custody (type/url|file/meta/captured_by/captured_at/chain).
  - Confiscation مع سير الضبط والتسليم وإيصال تسليم مرتبط بإجراء.
  - حماية صارمة لمرفقات الدرجة الرابعة وإخفاء البيانات الحساسة لغير المخولين.

- توسيع كتالوج المخالفات:
  - إضافة مزيد من Violations من الوثيقة المرجعية، مع اختبارات idempotency لتأكّد من وجود الأكواد الأساسية.

- تقارير ومؤشرات (KPIs):
  - توزيع الوقائع حسب الدرجة/الحالة، امتثال SLA، تكرار المخالفات، تحويلات الغياب؛ مع واجهة REST للتقارير والتصدير.

- تحسينات واجهة أمامية حدّ أدنى:
  - عرض repeat_index و suggested_actions وزر «إشعار وليّ الأمر» في IncidentForm/Card.
  - لوحة «مشرف الجناح» لإدارة ExcuseRequests وعرض المرفقات والقرارات.

- إحكام RBAC والخصوصية:
  - أذونات انتقالات سير العمل، وتقييد وصول صارم لدرجة 4.
  - عزل تخزين مرفقات الدرجة الرابعة وتنقيح الاستجابات.

#### 3) تعليمات تشغيل سريعة (Dev/QA)
- عند تعذّر Postgres محليًا: backend/.env → DATABASE_URL=sqlite:///backend/db.sqlite3.
- ثم:
  - python manage.py makemigrations discipline
  - python manage.py migrate
  - python manage.py discipline_seed_catalog
  - python manage.py setup_phase1_attendance
  - pytest -q tests/

#### 4) مراجع الملفات ذات الصلة
- النماذج والمسارات: backend/discipline/models.py, serializers.py, views.py, urls.py
- أوامر التهيئة: backend/discipline/management/commands/
- الإعدادات: backend/core/settings_base.py (+ settings_dev.py)
- وثائق مرجعية: DOC/repo/اللائحة_السلوكية.md، هذا الملف.

#### 5) حالة التنفيذ (مختصرة)
- الإنجاز: مسار الأعذار، الإجراءات والمرفقات، التصعيد الديناميكي، إشعار وليّ الأمر + SLA، الكتالوج الأولي، RBAC وأوامر التهيئة، واختبارات أساسية — مكتمل.
- المتبقي: سير عمل الواقعة الكامل، Evidence/Confiscation وخصوصية الدرجة الرابعة، تقارير/KPIs، توسيع الكتالوج، وبعض تحسينات الواجهة — قادم ضمن الدفعة التالية.
