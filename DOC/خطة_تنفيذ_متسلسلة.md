# ✅ خطة تنفيذ متسلسلة (Executable Checklist)

مقصود هذه الوثيقة: تحويل الخطة الاحترافية إلى مهام عملية مرتبة زمنيًا مع تبعيات واضحة، أوامر تشغيل، ومعايير قبول. استخدم هذه القائمة خطوة بخطوة أثناء التنفيذ.

ملاحظات عامة:
- علامة [ ] = لم يبدأ، [x] = منجز، [~] = جارٍ.
- كل مرحلة تعتمد على التي قبلها، إلا إن ذُكر خلاف ذلك.
- يُفضّل فتح فرع Git لكل مرحلة: feature/phase-N-<slug>.

---

## المرحلة 0 — التحقق السريع وتشغيل البيئة
أهداف: تشغيل البيئة محليًا والتأكد من الصحة الأساسية.

- [ ] تشغيل البنية الأساسية محليًا
  - أمر: scripts/dev_up.ps1
  - نجاح: Postgres + Redis يعملان بدون أخطاء في السجلات.
- [ ] تشغيل الباك والفرونت معًا
  - أمر: scripts/dev_all.ps1
  - نجاح: livez على https://127.0.0.1:8443/livez ترجع 204، وhealthz 200.
- [ ] عامل المهام RQ
  - أمر: scripts/rq_worker.ps1 -Queue default
  - نجاح: اتصال Redis ناجح وعامل في وضع الاستماع.
- [ ] تحديث README بقسم التشغيل السريع إن لزم
  - ملفات: README.md
  - نجاح: يتضمن أوامر scripts أعلاه.

تعريف الانتهاء (DoD):
- الوصول إلى /admin يعمل، وhealthz/livez ناجحة، وسجلات عامل RQ تؤكد الاتصال.

---

## المرحلة 1 — حوكمة الشفرة والمعمارية
أهداف: توحيد بنية الواجهة وإعدادات الباك واعتماد أدوات الجودة.

تبعية: المرحلة 0.

Frontend:
- [ ] إنشاء هيكل مجلدات frontend/src وفق المقترح (app, services, modules, shared)
- [ ] تثبيت الحزم: pinia, vue-router@4, @tanstack/vue-query, vue-i18n, vee-validate, zod, vue-toastification, vite-plugin-pwa
- [ ] إعداد Axios + Interceptors + Refresh في services/http.ts
- [ ] إضافة Router Guards + RBAC مبدئي

Backend:
- [ ] تفعيل DRF وتهيئة DEFAULT_AUTHENTICATION_CLASSES
- [ ] اختيار طريقة المصادقة (JWT الموصى به) وضبط simplejwt
- [ ] وضع أساس RBAC للأذونات (attendance, grades, timetable, notifications)

Quality:
- [ ] تفعيل linters: eslint + prettier للفرونت، black/flake8/isort للباك (mypy اختياري)

DoD:
- تشغيل dev_all بلا أخطاء لِنتر أساسية، توثيق موجز في README.

---

## المرحلة 2 — i18n + RTL + الوصولية (A11y)
تبعية: المرحلة 1.

- [ ] i18n: إنشاء app/i18n.ts بـ ar افتراضي و en احتياطي
- [ ] RTL: تفعيل RTL في الـ UI framework أو Tailwind RTL
- [ ] A11y: مراجعة التباين، تنقل الكيبورد، ARIA labels، التركيز في المودال

DoD:
- التبديل بين ar/en يعدّل dir تلقائيًا، لا انعكاسات غير مقصودة.

---

## المرحلة 3 — وحدة الحضور (Pilot End-to-End)
تبعية: المرحلة 2.

Backend:
- [ ] نموذج Attendance + فهارس (class_id,date) و (student_id,date)
- [ ] DRF ViewSet/Serializer + فلاتر date,classId
- [ ] صلاحيات attendance:read/write
- [ ] مهام RQ عند الغياب/التأخر (إشعار أو ملخص يومي)
- [ ] اختبارات Django (API/Permissions/Serializers)

Frontend:
- [ ] modules/attendance: api.ts, useAttendance.ts, components/AttendanceTable.vue, pages/AttendancePage.vue
- [ ] Vue Query تفاؤلي + اختصارات P/A/L + Toasts

Offline/PWA:
- [ ] إعداد vite-plugin-pwa + Workbox + Background Sync/Queue لطلبات POST /attendance

Realtime:
- [ ] قنوات WebSocket أو بث عبر RQ → WebSocket للحدث attendance:updated

DoD:
- تحميل قائمة الطلاب < 1s بعد التخزين، إدخال شبه فوري، عند الانقطاع تتم المزامنة لاحقًا.

---

## المرحلة 4 — الدرجات والجداول والإشعارات
تبعية: المرحلة 3.

- [ ] Grades: سير عمل draft → pending_approval → published + RBAC + سجل تدقيق
- [ ] Timetable: CRUD مبسط + فلاتر حسب الصف/المعلم/المادة
- [ ] Notifications: نموذج Notification + قناة WebSocket + Badge/Toasts

DoD:
- نشر الدرجات بموافقة، إشعارات لحظية وتظهر في الواجهة.

---

## المرحلة 5 — الأمان والمراقبة
تبعية: المرحلة 3 (يمكن تنفيذها بالتوازي الجزئي مع 4).

- [ ] JWT: Access قصير + Refresh في Cookie HttpOnly + تدوير
- [ ] CSRF/XSS: تفعيل CSRF للجلسات وتعقيم الحقول الغنية
- [ ] Logging JSON مع request_id + تكامل Sentry (باك/فرونت)
- [ ] Health: استمرار /healthz و /livez واستخدامهما في CI/المنصة
- [ ] نسخ احتياطي PostgreSQL مجدول + مراقبة Redis

DoD:
- تقارير أخطاء عملية، فحوص أمنية أساسية ناجحة.

---

## المرحلة 6 — الأداء
تبعية: المرحلة 4 و/أو 5.

Backend:
- [ ] تحسين فهارس + select_related/prefetch_related + Caching للثوابت

Frontend:
- [ ] Lazy routes/components + ضبط staleTime/cacheTime + select في Vue Query

Assets:
- [ ] Brotli/Gzip + تحليل الباندل بـ rollup-plugin-visualizer

DoD:
- P50 < 200ms، P95 < 400ms، حزمة أصغر وTTI أقل.

---

## المرحلة 7 — CI/CD واختبارات تلقائية
تبعية: المراحل السابقة.

GitHub Actions:
- [ ] Backend: black --check, flake8, pytest, scripts/full_audit.ps1
- [ ] Frontend: eslint, vitest, npm run build, رفع artefacts

CD:
- [ ] Frontend: Vercel/Netlify أو Nginx داخل Docker
- [ ] Backend: Render/Railway/DO + Postgres مُدار

DoD:
- كل Push يبني ويختبر ويُنتج معاينات تلقائيًا.

---

## لوح المهام والقبول (IDs)
اربط كل عنصر في القوائم أعلاه بالمعرفات التالية عند فتح Issues:
- FR-001، BE-001، ATT-001، ATT-002، PWA-001، RT-001، SEC-001، OBS-001، PERF-001، CI-001

---

## طريقة العمل المقترحة (Sprint-wise)
- أسبوع 1: المرحلة 1 + 2
- أسبوع 2: المرحلة 3 + أجزاء من 5 (أمن أساسي) + بدء 7 (CI بسيط)
- أسبوع 3: المرحلة 4 + 6 + إكمال 5 و7