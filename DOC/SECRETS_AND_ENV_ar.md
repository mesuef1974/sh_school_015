# الأسرار والمتغيرات البيئية (ENV)

هذه الوثيقة تحدد سياسة إدارة الأسرار والمتغيرات البيئية عبر بيئات التطوير والاختبار والمرحلة والإنتاج. الهدف هو منع التسريبات، تسهيل التهيئة الآمنة، وتوحيد الممارسات.

---

## 1) المبادئ العامة
- لا تُخزّن أي أسرار حقيقية داخل المستودع (Git) إطلاقًا.
- استخدم ملفات `.env` محلية غير مُضافة إلى Git + مدير أسرار للبيئات البعيدة (GitHub Environments/Cloud Secrets/KMS).
- أقل امتياز ممكن: قسّم الأسرار حسب الخدمة والبيئة، ولا تعِد استخدامها.
- التدوير الدوري للمفاتيح الحساسة (نصف سنوي على الأقل أو عند الاشتباه).

## 2) طبقات الأسرار
- مستوى التطبيق: مفاتيح Django SECRET_KEY، مفاتيح JWT، SALTs.
- مستوى البيانات: بيانات اتصال PostgreSQL (host, db, user, password)، سلاسل الاتصال.
- مستوى البنية: مفاتيح SMTP/S3/مزودي الرسائل، DSN لـ Sentry، مفاتيح API خارجية.

## 3) إدارة البيئات
- التطوير (dev): ملفات `.env` على الأجهزة المحلية مستندة إلى أمثلة `.env.example`، أسرار مزيفة/تجريبية.
- الاختبار/المرحلة (test/stage): أسرار تُدار عبر مدير أسرار في المنصة (GitHub Environments أو Vault/KMS) مع وصول محدود.
- الإنتاج (prod): أسرار تُدار مركزيًا، وصول مقيد جدًا، مراقبة وصول، تدقيق دوري.

## 4) ملفات الأمثلة
- تمت إضافة أمثلة:
  - `backend/.env.example`: إعدادات Django/DRF/DB/Redis/Sentry/Email.
  - `frontend/.env.example`: إعدادات Vite/Sentry/PWA/اللّغة.
- استخدمهما كنقطة انطلاق وأنشئ ملفات `.env` فعلية محلية دون رفعها إلى Git.

## 5) توصيات أمنية لـ Django/DRF
- عيّن `DJANGO_DEBUG=false` في الإنتاج.
- استخدم `DJANGO_ALLOWED_HOSTS` و`DJANGO_TRUSTED_ORIGINS` بدقة.
- فعّل رؤوس الأمان: HSTS، CSP، X-Frame-Options، X-Content-Type-Options، Referrer-Policy.
- JWT: Access قصير (10–15 دقيقة) + Refresh كـ Cookie HttpOnly؛ فعّل التدوير والقائمة السوداء.

## 6) CORS/CSRF
- حدّد `CORS_ALLOWED_ORIGINS` بمنشأ واجهة الإنتاج فقط.
- استخدم `CSRF_TRUSTED_ORIGINS` للنطاقات الموثوقة.
- لا تُفعّل CORS الشامل في الإنتاج.

## 7) قاعدة البيانات وRedis
- لا تستخدم مستخدم postgres الافتراضي في الإنتاج؛ أنشئ مستخدم خدمة بصلاحيات محدودة.
- استخدم TLS لقاعدة البيانات إن أمكن؛ واحصر الوصول بشبكة خاصة/جدار ناري.
- أنشئ كلمات مرور قوية وطويلة، ودوّرها دوريًا.

## 8) البريد والإشعارات
- استخدم مزودًا يدعم مفاتيح API ومجالات مرسلة موثّقة (SPF/DKIM/DMARC).
- خزن مفاتيح البريد في مدير أسرار، لا في Git.

## 9) Sentry والمراقبة
- استخدم DSN مختلف لكل بيئة، مع عينّات tracing مناسبة.
- لا تسجل بيانات شخصية حساسة؛ فعّل إخفاء/تنقية (PII scrubbing).

## 10) النسخ الاحتياطي ومفاتيح التشفير
- خزن لقطات/نسخ DB في مخزن مشفّر بحقوق وصول محدودة.
- لا تُخزّن مفاتيح فك التشفير مع النسخ الاحتياطية.

## 11) الاستعادة والطوارئ
- تمرين استعادة ربع سنوي موثّق (خطوات + أزمنة RTO/RPO الفعلية).
- قنوات اتصال طوارئ ومَن المخول بإجراء الدوران/الإيقاف.

## 12) الإنفاذ في CI/CD
- استخدم GitHub Environments/Secrets.
- فعّل ماسحات أسرار تلقائية (push/PR).
- لا تطبع الأسرار في السجلات.

## 13) نماذج عملية
- إنشاء `.env` محلي:
  - `cp backend/.env.example backend/.env`
  - `cp frontend/.env.example frontend/.env`
  - حدّث القيم حسب بيئتك، ثم شغّل `scripts/dev_all.ps1`.

## 14) المسؤوليات
- المالك الأمني (Security Owner): الموافقة على أي تغيير حساس.
- Dev Lead: مراجعة تغييرات تكوين الإنتاج.
- Ops: إدارة مخازن الأسرار ومراقبة الوصول.

— حرّر هذا الملف دوريًا عند أي إضافة/تغيير في الأسرار أو البيئات.